<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>The Ark</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-firestore-compat.js"></script>

  <script>
    // ‚úÖ GLOBAL VARIABLES ‚Äî must be outside window.onload
    let userInfo = null;
    let db = null;
    let currentCommunityId = null;
    let currentComplexId = null;
    let currentComplexName = "";
  </script>


  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #0a0a0a;
      color: white;
      padding: 20px;
      margin-bottom: 70px;
    }
    .btn {
      background: linear-gradient(135deg, #1a73e8, #00e0ff);
      color: white;
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 10px;
      margin-top: 20px;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.3s ease;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(0, 224, 255, 0.4);
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: #121212;
      display: flex;
      justify-content: space-around;
      border-top: 1px solid #333;
      z-index: 10000;
    }
    .bottom-nav button {
      flex: 1;
      background: none;
      color: white;
      padding: 12px 0;
      font-size: 14px;
      border: none;
    }
    .community-card {
      background: linear-gradient(135deg, #1a1a1a, #0e0e0e);
      border: 1px solid #333;
      border-radius: 14px;
      padding: 18px;
      margin-top: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.4);
      transition: transform 0.2s ease, box-shadow 0.3s ease;
      cursor: pointer;
    }
    .community-card:hover {
      transform: scale(1.02);
      box-shadow: 0 0 15px rgba(0, 224, 255, 0.2);
    }
    .community-card h3 {
      color: #00e0ff;
      margin-bottom: 6px;
    }
    .community-card p {
      font-size: 14px;
      color: #ccc;
    }
    #community-modal,
    #detail-modal,
    #add-complex-modal,
    #cell-modal,
    #add-cell-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.85);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: #1c1c1c;
      color: white;
      padding: 24px;
      border-radius: 14px;
      width: 90%;
      max-width: 420px;

      /* üî• NEW SCROLLING AND HEIGHT */
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-content input,
    .modal-content textarea {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      margin-bottom: 10px;
      background: #121212;
      color: white;
      border-radius: 6px;
      border: 1px solid #333;
    }
    #complex-feed {
      margin-top: 20px;
      background: #111;
      padding: 16px;
      border-radius: 12px;
      border: 1px dashed #333;
      color: #999;
      text-align: center;
    }
    .tag-badge {
      display: inline-block;
      background: #1a1a1a;
      border: 1px solid #00e0ff;
      color: #00e0ff;
      padding: 4px 10px;
      margin: 4px 4px 0 0;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }

    .profile-section {
      margin-top: 30px;
      background: #111;
      border-radius: 12px;
      padding: 16px;
      border: 1px solid #333;
    }
    .cell-preview-card {
    background: linear-gradient(135deg, #1c1c1c, #111111);
    border: 1px solid #444;
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 14px;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
  }

    
  </style>
  <style>
    .complex-card {
      background: linear-gradient(180deg, #101010, #0a0a0a);
      border: 2px solid #00e0ff;
      border-radius: 20px;
      padding: 24px;
      margin: 20px auto;
      max-width: 380px;
      height: 460px;
      box-shadow: 0 0 25px rgba(0, 224, 255, 0.2);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      transition: transform 0.2s ease, box-shadow 0.3s ease;
    }

    .complex-card h2 {
      color: #00e0ff;
      font-size: 20px;
      text-align: center;
      margin-bottom: 12px;
    }

    .complex-summary {
      color: #ccc;
      font-size: 14px;
      text-align: center;
      flex-grow: 1;
      overflow-y: auto;
      padding: 0 10px;
      max-height: 200px;
    }

    .complex-buttons {
      display: flex;
      justify-content: space-around;
      margin-top: 20px;
    }

    .btn-complex,
    .btn-outline {
      padding: 8px 12px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: bold;
      white-space: nowrap;
      max-width: 48%;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .btn-complex {
      background-color: #00e0ff;
      color: #000;
      border: none;
    }

    .btn-outline {
      background: none;
      border: 1px solid #00e0ff;
      color: #00e0ff;
    }

    .btn-complex:hover,
    .btn-outline:hover {
      transform: translateY(-2px);
      box-shadow: 0 0 12px rgba(0, 224, 255, 0.4);
    }
    .community-card {
      width: calc(50% - 12px);
      display: inline-block;
      vertical-align: top;
      margin: 6px;
      background: linear-gradient(135deg, #1f1f1f, #0e0e0e);
    }

  </style>
  

  
</head>
<body>


  <!-- TABS -->
  
  <div id="home" class="tab-content active" style="position: relative;">
    <!-- Standalone Complex Button -->
    <button class="btn" style="
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 13px;
      padding: 8px 16px;
      z-index: 10;
      background: linear-gradient(135deg, #00e0ff, #1a73e8);
      border-radius: 12px;
    " onclick="openStandaloneComplexModal()">‚ûï Create Standalone Complex</button>

    <!-- Featured Complexes -->
    <h2 style="margin-top: 60px;">üì¶ Featured Complexes</h2>
    <div id="home-complex-list" style="margin-top: 20px;"></div>

    <!-- Recommended Feed -->
    <h2 style="margin-top: 40px;">üîç Recommended for You</h2>
    <ul style="padding-left: 20px; color: #ccc; font-size: 14px;">
      <li>üß† AI in Healthcare</li>
      <li>üåç Climate Policy Scenarios</li>
      <li>ü™ô Bitcoin‚Äôs Energy Impact</li>
    </ul>
  </div>


 


  <div id="research" class="tab-content"><h2>üîç Research</h2><p>Coming soon‚Ä¶</p></div>

  <div id="communities" class="tab-content">
    <h2>üåê Explore Communities</h2>

    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
      <button class="btn" onclick="openCommunityModal()">+ Join or Create</button>
    
      <select id="community-sort" class="btn" style="background:#222; border:1px solid #333;" onchange="loadCommunities()">
        <option value="newest">üÜï Newest</option>
        <option value="members">üë• Most Members</option>
      </select>

      <button class="btn" onclick="toggleCommunityView()" id="toggle-view-btn">Show All Communities</button>
    </div>

    <div id="community-list" style="margin-top:30px;"></div>
  </div>


  <div id="my-communities" class="tab-content">
    <h2>üìÅ My Communities</h2>

    <h3>üëë Communities You Created</h3>
    <div id="created-community-list" style="margin-bottom: 40px;"></div>

    <h3>üß¨ Communities You Joined</h3>
    <div id="joined-community-list"></div>
  </div>

  <div id="profile" class="tab-content">
   <!-- üë§ User Profile Header -->
<div style="text-align: center; margin-bottom: 20px;">
  <img id="profile-photo" src="" alt="Profile Photo" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 2px solid #00e0ff;" />
  <h2 id="profile-name" style="margin-top: 10px;">üë§ Username</h2>

  <!-- üßæ Bio display -->
  <p id="profile-bio-text" style="color: #aaa; font-size: 14px; margin-top: 8px;">Click to add your bio</p>

  <!-- üìù Bio editing (initially hidden) -->
  <textarea id="profile-bio-input" style="display:none; width: 100%; background: #121212; color: #ccc; border: 1px solid #444; border-radius: 8px; padding: 8px; margin-top: 10px;" rows="3" placeholder="Edit your bio..."></textarea>

  <!-- üîò Bio action buttons -->
  <div style="margin-top: 10px;">
    <button class="btn" id="edit-bio-btn" onclick="editBio()">‚úèÔ∏è Edit Bio</button>
    <button class="btn" id="save-bio-btn" onclick="saveBio()" style="display: none;">üíæ Save Bio</button>
    <button class="btn" onclick="shareProfile()">üîó Share My Profile</button>
  </div>

  <p id="user-stats" style="color: #ccc; margin-top: 10px;">Loading...</p>
</div>


      

    <!-- üß≠ Tab Navigation -->
    <div style="display: flex; justify-content: center; gap: 20px; margin: 20px 0;">
      <button class="btn" id="tab-communities" onclick="showProfileTab('communities')">ü´Ç Communities</button>
      <button class="btn" id="tab-complexes" onclick="showProfileTab('complexes')">üß† Complexes</button>
      <button class="btn" id="tab-featured" onclick="showProfileTab('featured')">‚≠ê Featured</button>

    </div>
    <div id="profile-featured" class="profile-section-tab" style="display: none;">
      <div class="profile-section">
        <h3>‚≠ê Featured Complexes</h3>
        <p style="color: #999;">Coming soon...</p>
      </div>
    </div>

    <!-- üìÇ Content Sections (toggle based on tab) -->

    <!-- COMMUNITIES TAB -->
    <div id="profile-communities" class="profile-section-tab">
      <div class="profile-section">
        <h3>üëë Communities You Created</h3>
        <div id="user-created-communities"></div>
      </div>

      <div class="profile-section">
        <h3>üß¨ Communities You Joined</h3>
        <div id="user-joined-communities"></div>
      </div>
    </div>

    <!-- COMPLEXES TAB -->
    <div id="profile-complexes" class="profile-section-tab" style="display: none;">
      <div class="profile-section">
        <h3>üì¶ Complexes You Created</h3>
        <div id="user-complexes"></div>
      </div>

      <div class="profile-section">
        <h3>üåê Complexes in Communities</h3>
        <div id="user-community-complexes">Coming soon...</div>
      </div>
    </div>
  </div>





  
  <!-- Modals -->
  <div id="community-modal">
    <div class="modal-content">
      <h2>Create a Community</h2>
      <input id="community-name" type="text" placeholder="Community Name" />
      <textarea id="community-summary" placeholder="Short Summary (optional)"></textarea>
      <input id="community-tags" type="text" placeholder="Tags (comma separated, e.g. ai,health,data)" />
      <button class="btn" onclick="submitCommunity()">Create</button>
      <button class="btn" style="background:#444; margin-left:10px;" onclick="closeCommunityModal()">Cancel</button>
    </div>
  </div>


  <div id="detail-modal">
    <div class="modal-content" style="display: flex; flex-direction: column; max-height: 90vh; overflow: hidden;">
      <h2 id="detail-name">Community Name</h2>
      <p id="detail-summary">Summary will appear here.</p>

    <!-- Sticky Buttons Container -->
      <div style="margin-bottom: 10px;">
        <button class="btn" onclick="openAddComplexModal()">‚ûï Create Complex</button>
      </div>

    <!-- Scrollable Complex List -->
      <div id="complex-feed" style="flex: 1; overflow-y: auto; padding: 10px; border: 1px dashed #333; background: #111; border-radius: 12px; margin-bottom: 10px;">
      üì¶ Complex feed coming soon...
      </div>

    <!-- Sticky Close Button -->
      <div style="margin-top: auto;">
        <button class="btn" onclick="closeDetailModal()">Close</button>
      </div>
    </div>
  </div>


  <div id="add-complex-modal">
    <div class="modal-content">
      <h2>Create a Complex</h2>
      <input id="complex-title" type="text" placeholder="Complex Name" />
      <textarea id="complex-summary" placeholder="Short Summary"></textarea>
      <button class="btn" onclick="submitComplex()">Create</button>
      <button class="btn" style="background:#444; margin-left:10px;" onclick="closeAddComplexModal()">Cancel</button>
    </div>
  </div>

  <div id="cell-modal">
    <div class="modal-content">
      <h2 id="cell-modal-title">Cells in Complex</h2>
      <div id="cell-list"></div>
      <button class="btn" onclick="openAddCellModal()">‚ûï Add Cell</button>
      <button class="btn" onclick="closeCellModal()">Close</button>
    </div>
  </div>

  <div id="add-cell-modal">
    <div class="modal-content">
      <h2>Add a Cell</h2>
      <input id="cell-title" type="text" placeholder="Cell Title" />
      <textarea id="cell-content" placeholder="Content or Summary"></textarea>
      <button class="btn" onclick="submitCell()">Add</button>
      <button class="btn" style="background:#444; margin-left:10px;" onclick="closeAddCellModal()">Cancel</button>
    </div>
  </div>

  <div id="standalone-complex-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.85); z-index:9999; justify-content:center; align-items:center;">
    <div class="modal-content">
      <h2>Create Standalone Complex</h2>
      <input id="standalone-title" type="text" placeholder="Complex Title" />
      <textarea id="standalone-summary" placeholder="Short Summary"></textarea>
    
      <h3>‚ûï Add a Cell</h3>
      <input id="standalone-cell-title" type="text" placeholder="Cell Title" />
      <textarea id="standalone-cell-content" placeholder="Cell Content"></textarea>

      <button class="btn" onclick="submitStandaloneComplex()">‚úÖ Save Complex</button>
      <button class="btn" style="background:#444; margin-left:10px;" onclick="closeStandaloneComplexModal()">Cancel</button>
    </div>
  </div>

  <!-- Complex Builder Modal (Step-by-Step) -->
<div id="complex-builder-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.85); z-index:9999; justify-content:center; align-items:center;">
  <div class="modal-content">
    <h2 id="builder-step-title">Step 1: Create Complex</h2>

  
    <!-- Step 1: Title + Summary -->
    <div id="step-1">
      <input id="builder-title" type="text" placeholder="Complex Title" />
      <textarea id="builder-summary" placeholder="Short Summary"></textarea>

      <!-- üîπ Tone selection dropdown -->
      <label for="aiToneSelect" style="margin-top: 10px; display:block;">Tone or Style (optional):</label>
      <select id="aiToneSelect" style="width: 100%; padding: 10px; border-radius: 8px; background: #121212; color: white; border: 1px solid #333; margin-bottom: 10px;">
        <option value="default">üéØ Default</option>
        <option value="formal">üìö Formal</option>
        <option value="poetic">üé≠ Poetic</option>
        <option value="educational">üìò Educational</option>
        <option value="visual">üé® Visual</option>
      </select>

      <!-- üîπ AI Generate Button -->
      <button class="btn" onclick="generateAITitleSummary()" style="margin-bottom: 10px;">‚ú® Generate Title + Summary with AI</button>

      <!-- üîπ AI Feedback Message -->
      <p id="aiStep1Message" style="color: #00e0ff; font-size: 13px; display: none;"></p>

      <button class="btn" onclick="goToStep(2)">Next ‚û°Ô∏è</button>
    </div>


    <!-- Step 2: Add Cells -->
    <div id="step-2" style="display:none; overflow-y: auto; max-height: 70vh;">
      <!-- üìù Manual Cell Input -->
      <input id="cell-temp-title" type="text" placeholder="Cell Title" />
      <textarea id="cell-temp-content" placeholder="Cell Content"></textarea>
      <button class="btn" onclick="addCellToBuilder()">‚ûï Add Cell</button>

      <!-- ü§ñ Generate with AI -->
      <button class="btn" onclick="generateAICells()" style="margin-top: 10px;">‚ú® Generate AI Cells</button>

      <!-- üîÑ AI Suggestions Scrollable -->
      <div id="aiCellSuggestions" style="margin-top: 20px; max-height: 200px; overflow-y: auto;"></div>

      <!-- üì¶ Preview of Added Cells -->
      <div id="cell-preview-list" style="margin-top:20px;"></div>

      <!-- üîÄ Navigation Buttons -->
      <button class="btn" onclick="goToStep(3)">Next ‚û°Ô∏è</button>
      <button class="btn" style="background:#444; margin-left:10px;" onclick="goToStep(1)">‚¨ÖÔ∏è Back</button>
    </div>


    <!-- Step 3: Review & Save -->
    <div id="step-3" style="display:none">
      <h3>üìò Complex Preview</h3>
      <p><strong>Title:</strong> <span id="preview-title"></span></p>
      <p><strong>Summary:</strong> <span id="preview-summary"></span></p>
      <div id="preview-cells" style="margin-top:10px;"></div>
      <button class="btn" onclick="submitComplexBuilder()">‚úÖ Save Complex</button>
      <button class="btn" style="background:#444; margin-left:10px;" onclick="goToStep(2)">‚¨ÖÔ∏è Back</button>
    </div>

    <button class="btn" style="background:#222; margin-top:20px;" onclick="closeComplexBuilder()">Cancel</button>
  </div>
</div>

<!-- üîç Complex Summary Input -->
<div style="margin: 20px 0;">
  <label for="complexSummaryInput">Enter a summary to generate a Complex:</label>
  <textarea id="complexSummaryInput" placeholder="e.g. The future of education in AI-driven societies..." rows="3" style="width: 100%; padding: 10px; border-radius: 10px;"></textarea>
</div>

<!-- ‚ö° Generate Button -->
<div style="margin-bottom: 20px;">
  <button id="generateAIButton" class="btn">‚ú® Generate with AI</button>
</div>

<!-- üì¶ AI Results Container -->
<div id="aiResults" style="background-color: #111; padding: 20px; border-radius: 12px; display: none;">
  <h3 style="color: #00e0ff;">üîÆ AI Generated Complex</h3>
  <div id="aiTitle" style="font-size: 18px; font-weight: bold; margin-bottom: 10px;"></div>
  <div id="aiCells"></div>
</div>

<!-- Add style for scrollable complex list and fix modal scrolling issues -->
<style>
  #complex-feed {
    margin-top: 20px;
    background: #111;
    padding: 16px;
    border-radius: 12px;
    border: 1px dashed #333;
    color: #999;
    text-align: center;
    max-height: 300px;
    overflow-y: auto;
  }
</style>
  
  
<script>
  let newComplexCells = [];
  let currentSimulationTargetIndex = null;
  let currentBuilderStep = 1;
  let simulationSuggestions

  function openComplexBuilderModal() {
  newComplexCells = [];
  currentBuilderStep = 1;

  document.getElementById("builder-title").value = "";
  document.getElementById("builder-summary").value = "";
  document.getElementById("cell-temp-title").value = "";
  document.getElementById("cell-temp-content").value = "";
  document.getElementById("preview-cells").innerHTML = "";
  document.getElementById("aiCellSuggestions").innerHTML = "";
  document.getElementById("cell-preview-list").innerHTML = "";

  goToStep(1);
  document.getElementById("complex-builder-modal").style.display = "flex";
}


  function goToStep(step) {
    currentBuilderStep = step;
    document.getElementById("builder-step-title").innerText = `Step ${step}: ${step === 1 ? "Create Complex" : step === 2 ? "Add Cells" : "Review"}`;
    document.getElementById("step-1").style.display = step === 1 ? "block" : "none";
    document.getElementById("step-2").style.display = step === 2 ? "block" : "none";
    document.getElementById("step-3").style.display = step === 3 ? "block" : "none";

    if (step === 3) {
      document.getElementById("preview-title").innerText = document.getElementById("builder-title").value;
      document.getElementById("preview-summary").innerText = document.getElementById("builder-summary").value;

      const preview = document.getElementById("preview-cells");
      preview.innerHTML = "";

      newComplexCells.forEach((cell, index) => {
        const div = document.createElement("div");
        div.className = "community-card";

        div.innerHTML = `
          <h4>${index + 1}. ${cell.title}</h4>
          <p>${cell.content.slice(0, 80)}...</p>
          ${cell.simulation ? `
            <div style="margin-top:10px; padding:10px; background:#1b1b1b; border:1px dashed #00e0ff; border-radius:8px;">
              <strong style="color:#00e0ff;">${cell.simulation.title}</strong>
              <p style="font-size:13px; color:#ccc;">${cell.simulation.description}</p>
            </div>` : ''
          }
        `;

        preview.appendChild(div);
      });
    }

  }

  function addCellToBuilder(title, content) {
    const cellTitle = title || document.getElementById("cell-temp-title").value.trim();
    const cellContent = content || document.getElementById("cell-temp-content").value.trim();

    if (!cellTitle || !cellContent) {
      alert("Please fill in both fields.");
      return;
    }

    // Push cell to memory
    newComplexCells.push({ title: cellTitle, content: cellContent });

    // Clear inputs
    document.getElementById("cell-temp-title").value = "";
    document.getElementById("cell-temp-content").value = "";

    // Re-render
    renderCellPreviewList();
  }
 


  // ‚úÖ Step 2: Create the Slider Simulation Renderer
  function renderSliderSimulation(simulation) {
    const config = simulation.config || {};
    const sliders = config.sliders || [];
    const output = config.output || "Output";

    const container = document.createElement("div");
    container.style.border = "1px solid #00e0ff";
    container.style.borderRadius = "12px";
    container.style.padding = "15px";
    container.style.marginTop = "10px";
    container.style.background = "#1a1a1a";
    container.style.boxShadow = "0 0 8px rgba(0,224,255,0.4)";
    container.style.color = "#fff";

    const title = document.createElement("h4");
    title.innerText = simulation.title;
    title.style.color = "#00e0ff";
    title.style.marginBottom = "10px";
    container.appendChild(title);

    const description = document.createElement("p");
    description.innerText = simulation.description;
    description.style.fontSize = "14px";
    description.style.color = "#ccc";
    container.appendChild(description);

    const values = {};
    const resultOutput = document.createElement("div");
    resultOutput.style.marginTop = "10px";
    resultOutput.style.padding = "8px";
    resultOutput.style.background = "#111";
    resultOutput.style.borderRadius = "6px";
    resultOutput.style.border = "1px dashed #00e0ff";
    resultOutput.innerText = `${output}: waiting for input...`;

    sliders.forEach(slider => {
      const wrapper = document.createElement("div");
      wrapper.style.marginBottom = "10px";

      const label = document.createElement("label");
      label.innerText = `${slider.name}:`;
      label.style.display = "block";
      label.style.marginBottom = "4px";
      wrapper.appendChild(label);

      const input = document.createElement("input");
      input.type = "range";
      input.min = slider.min;
      input.max = slider.max;
      input.value = (slider.min + slider.max) / 2;
      input.className = "slider-glow";
      input.style.width = "100%";

      const valueDisplay = document.createElement("span");
      valueDisplay.innerText = ` ${input.value}`;
      valueDisplay.style.color = "#0ff";
      label.appendChild(valueDisplay);

      values[slider.name] = parseFloat(input.value);

      input.oninput = () => {
        values[slider.name] = parseFloat(input.value);
        valueDisplay.innerText = ` ${input.value}`;
        // Example logic: just sum the values
        const total = Object.values(values).reduce((a, b) => a + b, 0);
        resultOutput.innerText = `${output}: ${total.toFixed(1)}`;
      };

      wrapper.appendChild(input);
      container.appendChild(wrapper);
    });

    container.appendChild(resultOutput);

    return container.outerHTML;
  }


  function renderCellPreviewList() {
  const container = document.getElementById("cell-preview-list");
  container.innerHTML = "";

  newComplexCells.forEach((cell, index) => {
    const div = document.createElement("div");
    div.className = "cell-preview-card";

    // ‚úÖ Add title and content as real DOM elements (not innerHTML)
    const title = document.createElement("h4");
    title.innerText = `${index + 1}. ${cell.title}`;
    div.appendChild(title);

    const content = document.createElement("p");
    content.innerText = cell.content.slice(0, 80) + "...";
    div.appendChild(content);

    // ‚úÖ If the cell has a simulation, render it visually
    if (cell && cell.simulation && cell.simulation.config) {
      const simBlock = renderSimulationBlock(cell.simulation);
      div.appendChild(simBlock);
    }


    // ‚úÖ Add button to open AI simulation modal
    const simButton = document.createElement("button");
    simButton.innerText = "‚ûï Add Simulation or Content";
    simButton.className = "btn";
    simButton.onclick = () => {
      currentSimulationTargetIndex = index;
      openSimulationModal(); // no argument needed
    };


    div.appendChild(simButton);
    container.appendChild(div);
  });
}

  function openSimulationModal() {
    document.getElementById("simulationModal").style.display = "flex";
    document.getElementById("simulationRequestInput").value = "";
    document.getElementById("simulationStatus").innerHTML = "";
    document.getElementById("simulationStatus").style.display = "none";
    document.getElementById("ai-sim-suggestion-list").innerHTML = "";
  }


  function submitComplexBuilder() {
    const name = document.getElementById("builder-title").value.trim();
    const summary = document.getElementById("builder-summary").value.trim();
    if (!name) {
      alert("Please provide a Complex title.");
      return;
    }

    const complexData = {
      name,
      summary,
      creatorId: userInfo?.id || null,
      communityId: currentCommunityId || null,
      createdAt: new Date(),
      cells: newComplexCells || []
    };

    
    db.collection("complexes").add({
      name,
      summary,
      communityId: currentCommunityId,
      createdAt: new Date(),
      cells: newComplexCells,
      createdBy: userInfo.id
    }).then(() => {
      alert("‚úÖ Complex created!");
      closeComplexBuilder();
      openDetailModal({ id: currentCommunityId, name });
    });
  }

  function closeDetailModal() {
    document.getElementById("detail-modal").style.display = "none";
  }
</script>

<!-- Replace old complex creation trigger -->
<script>
  function openAddComplexModal() {
    openComplexBuilderModal();
  }
</script>




  <!-- Continued from Part 1 -->
  <!-- Modals and Main Content were loaded above -->

  <!-- Bottom Navigation -->
  <div class="bottom-nav">
    <button onclick="showTab('home')">üè†</button>
    <button onclick="showTab('research')">üîç</button>
    <button onclick="showTab('communities')">üåê</button>
    <button onclick="showTab('my-communities'); loadMyCommunities()">üß¨</button>
    <button onclick="showTab('profile'); loadUserProfile()">üë§</button>

  </div>

<script>
function loadCommunities() {
  if (typeof db === "undefined" || !db || typeof db.collection !== "function") {
    console.error("‚ùå Firestore 'db' is not initialized or is null.");
    const container = document.getElementById("community-list");
    if (container) container.innerHTML = "<p style='color:red;'>Error loading communities. Please refresh the app.</p>";
    return;
  }

  const sort = document.getElementById("community-sort").value;
  const container = document.getElementById("community-list");

  if (!container) {
    console.error("‚ùå Element with id 'community-list' not found.");
    return;
  }

  container.innerHTML = "Loading...";

  let query = db.collection("communities");

  if (sort === "newest") {
    query = query.orderBy("createdAt", "desc");
  } else if (sort === "members") {
    query = query.orderBy("memberCount", "desc");
  }

  query.limit(20).get().then(snapshot => {
    container.innerHTML = "";
    snapshot.forEach(doc => {
      const data = doc.data();
      const div = document.createElement("div");
      div.className = "community-card";
      div.innerHTML = `<h3>üìò ${data.name}</h3><p>${data.summary || "No summary."}</p>`;
      div.onclick = () => openDetailModal({ ...data, id: doc.id });
      container.appendChild(div);
    });
  }).catch(error => {
    console.error("‚ùå Failed to load communities:", error);
    container.innerHTML = "<p style='color:red;'>Failed to load communities.</p>";
  });
}

</script>
<script>
function closeAllModals() {
  document.querySelectorAll('[id$="-modal"]').forEach(el => {
    el.style.display = 'none';
  });
}

function showProfileTab(tab) {
  document.getElementById("profile-communities").style.display = tab === "communities" ? "block" : "none";
  document.getElementById("profile-complexes").style.display = tab === "complexes" ? "block" : "none";
  document.getElementById("profile-featured").style.display = tab === "featured" ? "block" : "none";

  document.getElementById("tab-communities").style.opacity = tab === "communities" ? "1" : "0.5";
  document.getElementById("tab-complexes").style.opacity = tab === "complexes" ? "1" : "0.5";
  document.getElementById("tab-featured").style.opacity = tab === "featured" ? "1" : "0.5";
}

function showTab(tabId) {
  closeAllModals();
  document.querySelectorAll(".tab-content").forEach(el => el.classList.remove("active"));
  const tab = document.getElementById(tabId);
  if (tab) tab.classList.add("active");

  if (tabId === "home") loadHomeComplexes();
  if (tabId === "communities") loadCommunities();
  if (tabId === "my-communities") loadMyCommunities();
  if (tabId === "profile") loadUserProfile();
}
</script>


  <!-- üîÅ FULL LOGIC SCRIPT START AND FIREBASE -->

  

<script>

window.onload = function () {
  // ‚úÖ Telegram & Firebase Setup
  const tg = window.Telegram.WebApp;
  const loadedUser = tg?.initDataUnsafe?.user;
  if (!loadedUser || !loadedUser.id) {
    alert("Telegram user not loaded. Please restart the app.");
    return;
  }
  userInfo = {
    id: loadedUser.id,
    first_name: loadedUser.first_name,
    username: loadedUser.username || "",
    photo_url: loadedUser.photo_url || "",
    photoUrl: loadedUser.photo_url || "", // normalize for both cases
  };


  const firebaseConfig = {
    apiKey: "AIzaSyBCU2YmXwyT1v5kmUp1HRyUqEQ8eY0n73M",
    authDomain: "the-ark-app-7bf83.firebaseapp.com",
    projectId: "the-ark-app-7bf83",
    storageBucket: "the-ark-app-7bf83.appspot.com",
    messagingSenderId: "838041964191",
    appId: "1:838041964191:web:a91e9555e62d81f2ee84aa"
  };

  const app = firebase.initializeApp(firebaseConfig);
  db = firebase.firestore();

  // ‚úÖ Welcome Message
  const welcome = document.getElementById("welcome-message");
  if (welcome) welcome.innerText = `Hello, ${user}!`;

  // ‚úÖ Save Telegram user profile to Firestore if not exists
  const userRef = db.collection("users").doc(userInfo.id.toString());

    userRef.get().then((doc) => {
      if (!doc.exists) {
        userRef.set({
          telegramId: userInfo.id,
          firstName: userInfo.first_name,
          username: userInfo.username || "",
          photoUrl: userInfo.photo_url || "",
          createdAt: new Date()
        });
      }
    });
  
  
  // üîÅ Globals (assign without re-declaring)
  currentCommunityId = null;
  currentComplexId = null;
  currentComplexName = "";
  let showAll = false; // ‚úÖ you can declare this here, since it's not globally declared


  
  

  
  
 
 
  
  // ‚úÖ Load default content
  showTab("home");
  loadCommunities();
  loadHomeComplexes();  
  
  window.appReady = true;
  console.log("‚úÖ App is fully initialized.");
} 
  
</script>
  
<script>
// ‚úÖ Submit Complex (inside Community)
  function submitComplex() {
    if (!userInfo || !userInfo.id) {
      alert("User not loaded. Please refresh the app.");
      return;
    }

    const name = document.getElementById("complex-title").value.trim();
    const summary = document.getElementById("complex-summary").value.trim();

    if (!name || !currentCommunityId) {
      alert("Please provide a name and open this modal from inside a community.");
      return;
    }

    db.collection("complexes").add({
      name,
      summary,
      communityId: currentCommunityId,
      createdAt: new Date(),
      cells: [],
      createdBy: userInfo.id
    }).then(() => {
      alert("‚úÖ Complex created!");
      closeAddComplexModal();
      openDetailModal({ id: currentCommunityId, name });
    });
  }

</script> 



<script>

// ‚úÖ Submit Cell inside a Complex
  function submitCell() {
    const title = document.getElementById("cell-title").value.trim();
    const content = document.getElementById("cell-content").value.trim();

    if (!userInfo || !userInfo.id) {
      alert("User not loaded. Please refresh.");
      return;
    }

    if (!title || !content) {
      alert("Please fill out both the title and content of the cell.");
      return;
    }

    if (!currentComplexId) {
      alert("Complex ID is missing. Try re-entering the complex.");
      return;
    }

    const ref = db.collection("complexes").doc(currentComplexId);
    ref.update({
      cells: firebase.firestore.FieldValue.arrayUnion({ title, content })
    }).then(() => {
      document.getElementById("cell-title").value = "";
      document.getElementById("cell-content").value = "";
      closeAddCellModal();
      openCellModal({ name: currentComplexName }, currentComplexId);
    }).catch((error) => {
      alert("Failed to save the cell: " + error.message);
    });
  }
</script>

<script>
function loadMyCommunities() {
  const createdContainer = document.getElementById("created-community-list");
  const joinedContainer = document.getElementById("joined-community-list");

  createdContainer.innerHTML = "";
  joinedContainer.innerHTML = "";

  db.collection("communities")
    .where("members", "array-contains", userInfo.id)
    .onSnapshot((snapshot) => {
      snapshot.forEach((doc) => {
        const data = doc.data();
        const card = document.createElement("div");
        card.className = "community-card";
        card.onclick = () => openDetailModal({ ...data, id: doc.id });

        const name = document.createElement("h3");
        name.innerText = `üìò ${data.name}`;

        const summary = document.createElement("p");
        summary.innerText = data.summary || "No summary provided.";

        card.appendChild(name);
        card.appendChild(summary);

        if (data.createdBy === userInfo.id) {
          createdContainer.appendChild(card);
        } else {
          joinedContainer.appendChild(card);
        }
      });
    });
}
</script>

  


<script>
function toggleCommunityView() {
  alert("Toggle view is not implemented yet.");
}


function loadHomeComplexes() {
  const container = document.getElementById("home-complex-list");
  container.innerHTML = "Loading...";

  db.collection("complexes")
    .orderBy("createdAt", "desc")
    .limit(10)
    .onSnapshot(snapshot => {
      container.innerHTML = "";
      snapshot.forEach(doc => {
        const data = doc.data();

        const box = document.createElement("div");
        box.className = "complex-card";
        box.innerHTML = `
          <h2>üß† ${data.name}</h2>
          <p style="text-align:center; font-size:12px; color:#00e0ff; margin-top:5px;">
            ${data.communityId === null ? "#Standalone" : "#Community"}
          </p>
          <p class="complex-summary">${data.summary || "No summary."}</p>
          <div class="complex-buttons">
            <button class="btn-outline">üîó Share</button>
          </div>
        `;

        // ‚úÖ Safely create "Enter Complex" button and attach event
        const enterBtn = document.createElement("button");
        enterBtn.className = "btn-complex";
        enterBtn.innerText = "üö™ Enter Complex";
        enterBtn.onclick = () => openCellModal(data, doc.id);
        
        box.querySelector(".complex-buttons").prepend(enterBtn);
        container.appendChild(box);
      });
    });
}

function openCellModal(complexData, complexId) {
  currentComplexId = complexId;
  currentComplexName = complexData.name;

  document.getElementById("cell-modal-title").innerText = complexData.name;
  const list = document.getElementById("cell-list");
  list.innerHTML = "Loading...";

  db.collection("complexes").doc(complexId)
    .onSnapshot(doc => {
      const complex = doc.data();
      list.innerHTML = "";

      if (complex.cells && complex.cells.length > 0) {
        const container = document.createElement("div");
        container.style.display = "flex";
        container.style.flexWrap = "wrap";
        container.style.gap = "10px";

        complex.cells.forEach((cell, index) => {
          const div = document.createElement("div");
          div.className = "community-card";
          div.style.width = "calc(50% - 10px)";
          div.innerHTML = `<h4>${index + 1}. ${cell.title}</h4><p>${cell.content}</p>`;
  
          if (cell.simulation) {
            const simBlock = renderSimulationBlock(cell.simulation);
            div.appendChild(simBlock);
          }

          container.appendChild(div);
        });


        list.appendChild(container);
      } else {
        list.innerHTML = "No cells in this complex yet.";
      }
    });

  document.getElementById("cell-modal").style.display = "flex";
}

function openDetailModal(data) {
  currentCommunityId = data.id;
  document.getElementById("detail-name").innerText = data.name;
  document.getElementById("detail-summary").innerText = data.summary || "No summary.";
  const feed = document.getElementById("complex-feed");
  feed.innerHTML = "üì¶ Loading...";

  db.collection("complexes")
    .where("communityId", "==", data.id)
    .orderBy("createdAt", "desc")
    .onSnapshot(snapshot => {
      feed.innerHTML = "";
      if (snapshot.empty) {
        feed.innerHTML = "No complexes yet.";
        return;
      }

      snapshot.forEach(doc => {
        const complex = doc.data();
        const div = document.createElement("div");
        div.className = "complex-card";
        div.innerHTML = `
          <h2>üß† ${complex.name}</h2>
          <p style="text-align:center; font-size:12px; color:#00e0ff; margin-top:5px;">
            ${data.communityId === null ? "#Standalone" : "#Community"}
          </p>
          <p class="complex-summary">${complex.summary || "No summary."}</p>
          <div class="complex-buttons">
            <button class="btn-complex" onclick='openCellModal(${JSON.stringify(complex).replace(/"/g, "&quot;")}, "${doc.id}")'>üö™ Enter Complex</button>
            <button class="btn-outline">üîó Share</button>
          </div>
        `;
        feed.appendChild(div);
      });
    });

  document.getElementById("detail-modal").style.display = "flex";
}

function updateStats(statsEl, complexCount, createdCommCount, joinedCommCount) {
  statsEl.innerHTML = `
    üì¶ ${complexCount} complexes<br>
    üëë ${createdCommCount} communities created<br>
    üß¨ ${joinedCommCount} communities joined
  `;
}
</script>




<!-- ‚úÖ Modal helper functions go below this -->
<script>
  function openCommunityModal() {
    document.getElementById("community-modal").style.display = "flex";
  }
  function closeCommunityModal() {
    document.getElementById("community-modal").style.display = "none";
  }
  function closeAddComplexModal() {
    document.getElementById("add-complex-modal").style.display = "none";
  }
  function openStandaloneComplexModal() {
    document.getElementById("standalone-complex-modal").style.display = "flex";
  }
  function closeStandaloneComplexModal() {
    document.getElementById("standalone-complex-modal").style.display = "none";
  }
  function closeDetailModal() {
    document.getElementById("detail-modal").style.display = "none";
  }
  function closeCellModal() {
    document.getElementById("cell-modal").style.display = "none";
  }
  function closeAddCellModal() {
    document.getElementById("add-cell-modal").style.display = "none";
  }
  function openAddCellModal() {
    document.getElementById("add-cell-modal").style.display = "flex";
  }
</script>
  <script>
function toggleBioEdit() {
  const textarea = document.getElementById("profile-bio-input");
  const saveBtn = document.getElementById("save-bio-btn");
  const bioText = document.getElementById("profile-bio-text");

  // Show edit mode
  textarea.style.display = "block";
  saveBtn.style.display = "inline-block";
  bioText.style.display = "none";

  // Prefill textarea
  textarea.value = bioText.innerText.trim();
}

function saveBio() {
  const bio = document.getElementById("profile-bio-input").value.trim();
  const bioText = document.getElementById("profile-bio-text");

  if (!bio || !userInfo || !userInfo.id) return;

  db.collection("users").doc(userInfo.id.toString()).update({
    bio
  }).then(() => {
    bioText.innerText = bio;

    // Hide edit mode
    document.getElementById("profile-bio-input").style.display = "none";
    document.getElementById("save-bio-btn").style.display = "none";
    bioText.style.display = "block";
    document.getElementById("edit-bio-btn").style.display = "inline-block"; // <‚Äî This is missing


    alert("‚úÖ Bio saved!");
  }).catch(err => {
    alert("‚ùå Failed to save bio.");
    console.error(err);
  });
}
</script>

<script>
function shareProfile() {
  if (!userInfo || (!userInfo.username && !userInfo.id)) {
    alert("User info not loaded.");
    return;
  }

  const username = userInfo.username;

  if (!username || username.trim() === "") {
    alert("‚ùå You need to set a Telegram username in your Telegram settings to share your profile.");
    return;
  }

  const url = `https://theark.com/user/${username}`;
  navigator.clipboard.writeText(url).then(() => {
    alert("‚úÖ Profile link copied to clipboard!");
  }).catch(err => {
    console.error("‚ùå Failed to copy:", err);
    alert("Failed to copy link.");
  });
}

</script>

<script>
function editBio() {
  document.getElementById("profile-bio-text").style.display = "none";
  document.getElementById("profile-bio-input").style.display = "block";
  document.getElementById("save-bio-btn").style.display = "inline-block";
  document.getElementById("edit-bio-btn").style.display = "none";

  // Set the textarea value to current bio
  const currentBio = document.getElementById("profile-bio-text").innerText;
  document.getElementById("profile-bio-input").value = currentBio;
}
</script>
    
<script>
function submitStandaloneComplex() {
  const name = document.getElementById("standalone-title").value.trim();
  const summary = document.getElementById("standalone-summary").value.trim();
  const cellTitle = document.getElementById("standalone-cell-title").value.trim();
  const cellContent = document.getElementById("standalone-cell-content").value.trim();

  if (!name || !cellTitle || !cellContent) {
    alert("Please fill all fields.");
    return;
  }

  const newComplex = {
    name,
    summary,
    createdAt: new Date(),
    createdBy: userInfo.id,
    cells: [{ title: cellTitle, content: cellContent }],
    communityId: null
  };

  db.collection("complexes").add(newComplex).then(() => {
    alert("‚úÖ Standalone Complex created!");
    closeStandaloneComplexModal();

    // Clear form fields
    document.getElementById("standalone-title").value = "";
    document.getElementById("standalone-summary").value = "";
    document.getElementById("standalone-cell-title").value = "";
    document.getElementById("standalone-cell-content").value = "";

    loadHomeComplexes(); // ‚úÖ Refresh the list
  }).catch((error) => {
    console.error("‚ùå Failed to create standalone complex:", error.message);
    alert("Error: " + error.message);
  });
}
</script>
  
<script>
  function submitCommunity() {
    if (!db || !userInfo || !userInfo.id) {
      alert("‚ùå App not ready yet. Please wait a moment or refresh.");
      console.error("‚ùå submitCommunity error: db or userInfo not loaded.", db, userInfo);
      return;
    }

    const name = document.getElementById("community-name").value.trim();
    const summary = document.getElementById("community-summary").value.trim();
    const tagsInput = document.getElementById("community-tags").value.trim();
    const tags = tagsInput ? tagsInput.split(",").map(t => t.trim()).filter(Boolean) : [];

    if (!name) {
      alert("Please enter a community name.");
      return;
    }

    db.collection("communities").add({
      name,
      summary,
      createdBy: userInfo.id,
      members: [userInfo.id],
      memberCount: 1,
      tags,
      createdAt: new Date()
    }).then(() => {
      alert("‚úÖ Community created!");
      closeCommunityModal();
      loadCommunities();
    }).catch((error) => {
      console.error("‚ùå Error creating community:", error);
      alert("Failed to create community. See console for details.");
    });
  }
</script>


  
<script>
function loadUserProfile() {
  if (!userInfo || !userInfo.id || !userInfo.first_name) {
    console.error("‚ùå userInfo not loaded yet:", userInfo);
    return;
  }

  document.getElementById("profile-name").innerText = userInfo.first_name || "User";
  db.collection("users").doc(userInfo.id.toString()).get().then((doc) => {
  if (doc.exists) {
    const data = doc.data();
    const bioInput = document.getElementById("profile-bio");
    document.getElementById("profile-bio-text").innerText = data.bio || "No bio set.";

    }
  });
  const photo = userInfo.photoUrl || userInfo.photo_url;
  if (photo) {
    document.getElementById("profile-photo").src = photo;
  }

  const complexContainer = document.getElementById("user-complexes");
  const createdCommContainer = document.getElementById("user-created-communities");
  const joinedCommContainer = document.getElementById("user-joined-communities");
  const statsEl = document.getElementById("user-stats");

  complexContainer.innerHTML = "";
  createdCommContainer.innerHTML = "";
  joinedCommContainer.innerHTML = "";
  statsEl.innerHTML = "Loading...";

  let complexCount = 0;
  let createdCommCount = 0;
  let joinedCommCount = 0;

  db.collection("complexes").where("createdBy", "==", userInfo.id).onSnapshot(snapshot => {
    complexContainer.innerHTML = "";
    complexCount = snapshot.size;
    snapshot.forEach(doc => {
      const data = doc.data();
      const box = document.createElement("div");
      box.className = "complex-card";
      box.innerHTML = `
        <h2>üß† ${data.name}</h2>
        <p style="text-align:center; font-size:12px; color:#00e0ff; margin-top:5px;">
          ${data.communityId === null ? "#Standalone" : "#Community"}
        </p>
        <p class="complex-summary">${data.summary || "No summary."}</p>
        <div class="complex-buttons">
          <button class="btn-complex" onclick='openCellModal(${JSON.stringify(data).replace(/"/g, "&quot;")}, "${doc.id}")'>üö™ Enter Complex</button>
          <button class="btn-outline">üîó Share</button>
        </div>
      `;
      complexContainer.appendChild(box);
    });
    updateStats(statsEl, complexCount, createdCommCount, joinedCommCount);
  });

  const renderedCommunityIds = new Set();

  db.collection("communities").where("createdBy", "==", userInfo.id).onSnapshot(snapshot => {
    createdCommContainer.innerHTML = "";
    createdCommCount = 0;
    snapshot.forEach(doc => {
      const data = doc.data();
      const box = document.createElement("div");
      box.className = "community-card";
      box.innerHTML = `<h3>üìò ${data.name}</h3><p>${data.summary || "No summary."}</p>`;
      box.onclick = () => openDetailModal({ ...data, id: doc.id });
      createdCommContainer.appendChild(box);
      renderedCommunityIds.add(doc.id);
      createdCommCount++;
    });
    updateStats(statsEl, complexCount, createdCommCount, joinedCommCount);
  });

  db.collection("communities").where("members", "array-contains", userInfo.id).onSnapshot(snapshot => {
    joinedCommContainer.innerHTML = "";
    joinedCommCount = 0;
    snapshot.forEach(doc => {
      if (renderedCommunityIds.has(doc.id)) return;
      const data = doc.data();
      const box = document.createElement("div");
      box.className = "community-card";
      box.innerHTML = `<h3>üìò ${data.name}</h3><p>${data.summary || "No summary."}</p>`;
      box.onclick = () => openDetailModal({ ...data, id: doc.id });
      joinedCommContainer.appendChild(box);
      joinedCommCount++;
    });
    updateStats(statsEl, complexCount, createdCommCount, joinedCommCount);
  });
}
</script>

<script>
document.getElementById("generateAIButton").addEventListener("click", async () => {
  const summary = document.getElementById("complexSummaryInput").value.trim();
  const outputDiv = document.getElementById("aiResults");
  outputDiv.innerHTML = ""; // Clear previous results
  outputDiv.style.display = "block"; // ‚úÖ This is what was missing
  outputDiv.scrollIntoView({ behavior: 'smooth' });


  if (!summary) {
    outputDiv.innerHTML = "<p style='color: red;'>Please enter a summary first.</p>";
    return;
  }

  outputDiv.innerHTML = "<p>‚è≥ Generating your complex with AI...</p>";

  try {
    const response = await fetch('https://the-ark-ai-server.onrender.com/generate', {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ summary }),
    });

    const data = await response.json();
    console.log("üß™ AI Response in frontend:", data);

    if (data.error) {
      outputDiv.innerHTML = `<p style='color: red;'>‚ùå Error: ${data.error}</p>`;
      return;
    }

    // Show the generated content
    let html = `<h2 style="color:#00e0ff; margin-bottom: 20px;">üß† ${data.title}</h2>`;
    data.cells.forEach((cell, index) => {
      html += `
        <div style="
          background: #1a1a1a;
          border: 1px solid #333;
          border-radius: 12px;
          padding: 16px;
          margin-bottom: 16px;
          box-shadow: 0 0 10px rgba(0, 224, 255, 0.1);
        ">
          <h4 style="color:#00e0ff; margin-bottom:8px;">${index + 1}. ${cell.title}</h4>
          <p style="color:#ccc; font-size:14px;">${cell.content}</p>
        </div>
      `;
    });
    outputDiv.innerHTML = html;
    outputDiv.scrollIntoView({ behavior: 'smooth' });



  } catch (err) {
    outputDiv.innerHTML = `<p style='color: red;'>‚ùå Something went wrong while contacting the AI server.</p>`;
    console.error(err);
  }
});
</script>

<script>
async function generateAITitleSummary() {
  const title = document.getElementById("builder-title").value.trim();
  const tone = document.getElementById("aiToneSelect").value;
  const message = document.getElementById("aiStep1Message");

  message.style.display = "block";
  message.innerText = "‚è≥ Asking AI for suggestions...";

  try {
    const response = await fetch("https://the-ark-ai-server.onrender.com/generate-title-summary", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ title, tone })
    });

    const data = await response.json();

    if (data.error) {
      message.innerText = "‚ùå AI Error: " + data.error;
      return;
    }

    document.getElementById("builder-title").value = data.title || title;
    document.getElementById("builder-summary").value = data.summary || "";
    message.innerText = "‚úÖ AI suggestion applied! You can edit or regenerate.";
  } catch (err) {
    message.innerText = "‚ùå Failed to contact AI server.";
    console.error("AI Error:", err);
  }
}
</script>

<script>
async function generateAICells() {
  const title = document.getElementById("builder-title").value.trim();
  const summary = document.getElementById("builder-summary").value.trim();
  const suggestionsDiv = document.getElementById("aiCellSuggestions");

  suggestionsDiv.innerHTML = "<p style='color: #00e0ff;'>‚è≥ Generating cells...</p>";

  try {
    const response = await fetch("https://the-ark-ai-server.onrender.com/generate", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ summary: summary || title })
    });

    const data = await response.json();
    if (data.error) {
      suggestionsDiv.innerHTML = `<p style='color: red;'>‚ùå Error: ${data.error}</p>`;
      return;
    }

    suggestionsDiv.innerHTML = ""; // clear loading text

    // Show each suggested cell
    data.cells.forEach((cell) => {
      const card = document.createElement("div");
      card.style.border = "1px solid #444";
      card.style.borderRadius = "10px";
      card.style.padding = "10px";
      card.style.marginBottom = "10px";
      card.style.background = "#111";

      const titleEl = document.createElement("h4");
      titleEl.innerText = cell.title;

      const contentEl = document.createElement("p");
      contentEl.innerText = cell.content;

      const addButton = document.createElement("button");
      addButton.innerText = "‚ûï Add";
      addButton.className = "btn";
      addButton.onclick = () => {
        addCellToBuilder(cell.title, cell.content);
        addButton.innerText = "‚úÖ Added";
        addButton.disabled = true;
      };

      const editButton = document.createElement("button");
      editButton.innerText = "‚úèÔ∏è Edit";
      editButton.className = "btn";
      editButton.style.marginLeft = "10px";
      editButton.onclick = () => {
        document.getElementById("cell-temp-title").value = cell.title;
        document.getElementById("cell-temp-content").value = cell.content;
      };

      card.appendChild(titleEl);
      card.appendChild(contentEl);
      card.appendChild(addButton);
      card.appendChild(editButton);

      suggestionsDiv.appendChild(card);
    });

  } catch (err) {
    suggestionsDiv.innerHTML = `<p style='color: red;'>‚ùå Failed to generate AI cells.</p>`;
    console.error("AI cell generation error:", err);
  }
}

</script>

<script>
async function generateCellSuggestions() {
  const title = document.getElementById("builder-title").value.trim();
  const summary = document.getElementById("builder-summary").value.trim();
  const container = document.getElementById("aiCellSuggestions");

  container.innerHTML = "‚è≥ Asking AI for cell ideas...";

  try {
    const response = await fetch("https://the-ark-ai-server.onrender.com/generate", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ summary: summary || title })  // Fallback to title if no summary
    });

    const data = await response.json();

    if (data.error) {
      container.innerHTML = `‚ùå AI Error: ${data.error}`;
      return;
    }

    container.innerHTML = "<h4 style='color:#00e0ff;'>üß† AI Suggested Cells:</h4>";

    data.cells.forEach((cell, index) => {
      const div = document.createElement("div");
      div.style.background = "#111";
      div.style.padding = "10px";
      div.style.marginBottom = "10px";
      div.style.borderRadius = "10px";
      div.style.border = "1px solid #333";

      div.innerHTML = `
        <p><strong>${cell.title}</strong></p>
        <p>${cell.content}</p>
        <button class="btn" onclick="insertAISuggestedCell('${cell.title.replace(/'/g, "\\'")}', '${cell.content.replace(/'/g, "\\'")}')">‚úÖ Add</button>
        <button class="btn" style="background:#444;" onclick="editAISuggestedCell('${cell.title.replace(/'/g, "\\'")}', '${cell.content.replace(/'/g, "\\'")}')">‚úèÔ∏è Edit</button>
      `;

      container.appendChild(div);
    });

  } catch (err) {
    container.innerHTML = "‚ùå Failed to contact AI server.";
    console.error("AI Error:", err);
  }
}

function insertAISuggestedCell(title, content) {
  document.getElementById("cell-temp-title").value = title;
  document.getElementById("cell-temp-content").value = content;
  addCellToBuilder();
  document.getElementById("aiCellSuggestions").scrollIntoView({ behavior: 'smooth' });
}

function editAISuggestedCell(title, content) {
  document.getElementById("cell-temp-title").value = title;
  document.getElementById("cell-temp-content").value = content;
  document.getElementById("aiCellSuggestions").scrollIntoView({ behavior: 'smooth' });
}
</script>
  
<script>
let currentCellTarget = null;



function closeSimulationModal() {
  document.getElementById("simulationModal").style.display = "none";
  document.getElementById("simulationStatus").style.display = "none";
}



function applySimulationToCell(title, description, type = "generic", config = {}) {
  if (currentSimulationTargetIndex !== null && newComplexCells[currentSimulationTargetIndex]) {
    newComplexCells[currentSimulationTargetIndex].simulation = {
      title,
      description,
      type,
      config
    };
    renderCellPreviewList(); // Refresh
  }
  closeSimulationModal();
}



function editSimulation(title, description) {
  document.getElementById("simulationModal").style.display = "flex";
  document.getElementById("simulationRequestInput").value = `${title}: ${description}`;
}
</script>
  
<script>
  


function showAISuggestions(suggestions) {
  simulationSuggestions = suggestions; // ‚úÖ Save globally
  
  const simList = document.getElementById("ai-sim-suggestion-list");
  if (!simList) {
    console.warn("‚ö†Ô∏è Cannot find #ai-sim-suggestion-list container.");
    return;
  }

  simList.innerHTML = ""; // clear previous suggestions

  suggestions.forEach((sim, i) => {
    const card = document.createElement("div");
    card.className = "sim-choice-card";
    card.style.border = "1px solid #00e0ff";
    card.style.borderRadius = "10px";
    card.style.padding = "12px";
    card.style.marginBottom = "10px";
    card.style.background = "#111";

    card.innerHTML = `
      <h4 style="color:#0ff;">${sim.title} <span style="font-size:12px; color:#aaa;">(${sim.type})</span></h4>
      <p style="color:#ccc; font-size:13px;">${sim.description}</p>
      <button class="btn" onclick="addSimulationToCell(${i})">‚ûï Add This Simulation</button>
    `;

    simList.appendChild(card);
  });
}

function addSimulationToCell(index) {
  const sim = simulationSuggestions[index];
  if (!sim || currentSimulationTargetIndex == null) return;

  newComplexCells[currentSimulationTargetIndex].simulation = sim;
  renderCellPreviewList();
  closeSimulationModal();
}


function closeSimulationModal() {
  document.getElementById("simulationModal").style.display = "none";
}


function applySimulationFromList(index) {
  const sim = simulationSuggestions[index];
  if (!sim || currentSimulationTargetIndex === null) return;

  // ‚úÖ Fully store the simulation with config
  newComplexCells[currentSimulationTargetIndex].simulation = {
    title: sim.title || "Untitled Simulation",
    description: sim.description || "No description provided.",
    type: sim.type || "generic",
    config: sim.config ? { ...sim.config } : {} // very important!
  };

  // ‚úÖ Re-render preview and close modal
  renderCellPreviewList();
  closeSimulationModal();
}
console.log("‚úÖ Simulation saved to cell:", newComplexCells[currentSimulationTargetIndex].simulation);


</script>
  
<script>
function renderSimulationBlock(sim) {
  if (!sim || !sim.type) {
    console.warn("‚ö†Ô∏è No simulation type found");
    return document.createElement("div");
  }

  switch (sim.type) {
    case "slider": return renderSliderSimulation(sim);
    case "forecast": return renderForecastSimulation(sim);
    case "logic-tree":
    case "tree": return renderTreeSimulation(sim);
    case "narrative": return renderNarrativeSimulation(sim);
    case "map":
    case "animated-map": return renderAnimatedMapSimulation(sim);
    case "rich-text": return renderRichTextSimulation(sim);
    case "cause-effect": return renderCauseEffectSimulation(sim);
    default:
      const fallback = document.createElement("div");
      fallback.innerHTML = `<p style="color:red;">‚ö†Ô∏è Unknown simulation type: ${sim.type}</p>`;
      return fallback;
  }
}



</script>

<script>
// ‚úÖ Updated renderSliderSimulation with animations and modern design
function renderSliderSimulation(sim) {
  const container = document.createElement("div");
  container.className = "simulation-card";
  container.style.border = "1px solid #00e0ff";
  container.style.borderRadius = "12px";
  container.style.padding = "16px";
  container.style.marginTop = "10px";
  container.style.background = "#111";
  container.style.boxShadow = "0 0 10px rgba(0, 224, 255, 0.2)";
  container.style.transition = "all 0.3s ease-in-out";

  const title = document.createElement("h4");
  title.innerHTML = "üìä " + sim.title;
  title.style.color = "#00e0ff";
  title.style.marginBottom = "8px";
  container.appendChild(title);

  const desc = document.createElement("p");
  desc.innerText = sim.description;
  desc.style.color = "#ccc";
  desc.style.fontSize = "13px";
  desc.style.marginBottom = "12px";
  container.appendChild(desc);

  const sliders = sim.config.sliders || [];
  const output = document.createElement("div");
  output.style.marginTop = "10px";
  output.style.fontWeight = "bold";
  output.style.color = "#00e0ff";

  // Initialize state
  let values = {};
  sliders.forEach(sl => values[sl.name] = (sl.min + sl.max) / 2);

  // Function to update output text (can be improved with real formulas)
  function updateOutput() {
    let resultText = sim.config.output || "Result";
    const sum = Object.values(values).reduce((a, b) => a + b, 0);
    output.innerText = `üîé ${resultText}: ${Math.round(sum)}`;
  }

  // Render sliders
  sliders.forEach(sl => {
    const label = document.createElement("label");
    label.innerText = `${sl.name}: `;
    label.style.color = "#aaa";
    label.style.display = "block";
    label.style.marginTop = "6px";

    const range = document.createElement("input");
    range.type = "range";
    range.min = sl.min;
    range.max = sl.max;
    range.value = (sl.min + sl.max) / 2;
    range.style.width = "100%";
    range.className = "neon-slider";

    const val = document.createElement("span");
    val.innerText = range.value;
    val.style.marginLeft = "10px";
    val.style.color = "#0ff";

    range.oninput = () => {
      val.innerText = range.value;
      values[sl.name] = Number(range.value);
      updateOutput();
    };

    container.appendChild(label);
    container.appendChild(range);
    container.appendChild(val);
  });

  container.appendChild(output);
  updateOutput();
  return container;
}

  


function renderForecastSimulation(sim) {
  const container = document.createElement("div");
  container.style.border = "1px solid #333";
  container.style.borderRadius = "12px";
  container.style.padding = "15px";
  container.style.background = "#121212";
  container.style.marginTop = "15px";

  const title = document.createElement("h4");
  title.innerHTML = sim.title || "üìà Forecast Simulation";
  title.style.color = "#00e0ff";
  container.appendChild(title);

  const desc = document.createElement("p");
  desc.innerText = sim.description || "This simulation shows a trend forecast over time.";
  desc.style.color = "#ccc";
  desc.style.fontSize = "14px";
  container.appendChild(desc);

  const canvas = document.createElement("canvas");
  container.appendChild(canvas);

  setTimeout(() => {
    new Chart(canvas, {
      type: "line",
      data: {
        labels: sim.config.labels,
        datasets: [{
          label: sim.config.label || "Forecast",
          data: sim.config.values,
          borderColor: "#00e0ff",
          backgroundColor: "rgba(0, 224, 255, 0.2)",
          fill: true,
          tension: 0.4,
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { labels: { color: "#ccc" } },
        },
        scales: {
          x: { ticks: { color: "#ccc" }, grid: { color: "#222" } },
          y: { ticks: { color: "#ccc" }, grid: { color: "#222" } }
        }
      }
    });
  }, 100); // Delay to ensure canvas is in DOM

  return container;
}


function renderTreeSimulation(sim) {
  const container = document.createElement("div");
  container.style.border = "1px solid #333";
  container.style.borderRadius = "12px";
  container.style.padding = "15px";
  container.style.background = "#121212";
  container.style.marginTop = "15px";
  container.style.fontFamily = "sans-serif";

  const title = document.createElement("h4");
  title.innerHTML = sim.title || "üß≠ Decision Tree Simulation";
  title.style.color = "#00e0ff";
  container.appendChild(title);

  const desc = document.createElement("p");
  desc.innerText = sim.description || "This simulation shows how decisions lead to consequences.";
  desc.style.color = "#ccc";
  desc.style.fontSize = "14px";
  container.appendChild(desc);

  const treeDiv = document.createElement("div");
  treeDiv.style.marginTop = "10px";
  container.appendChild(treeDiv);

  // Recursive function to render nodes
  function renderNode(nodeId, depth = 0) {
    const node = sim.config.nodes.find(n => n.id === nodeId);
    if (!node) return;

    const nodeEl = document.createElement("div");
    nodeEl.style.marginLeft = `${depth * 20}px`;
    nodeEl.style.borderLeft = "2px solid #00e0ff";
    nodeEl.style.paddingLeft = "10px";
    nodeEl.style.marginTop = "5px";
    nodeEl.style.color = "#eee";
    nodeEl.innerText = node.text;

    treeDiv.appendChild(nodeEl);

    (node.children || []).forEach(childId => renderNode(childId, depth + 1));
  }

  // Start from root (first node)
  renderNode(sim.config.nodes[0].id);

  return container;
}
  
function renderRichTextSimulation(sim) {
  const container = document.createElement("div");
  container.style.marginTop = "15px";
  container.style.background = "#1a1a1a";
  container.style.padding = "15px";
  container.style.borderRadius = "10px";
  container.style.border = "1px solid #333";

  const title = document.createElement("h4");
  title.innerText = sim.title;
  title.style.color = "#00e0ff";
  container.appendChild(title);

  const desc = document.createElement("p");
  desc.innerText = sim.description;
  desc.style.color = "#aaa";
  desc.style.fontSize = "13px";
  container.appendChild(desc);

  const inner = document.createElement("div");
  inner.style.marginTop = "10px";
  container.appendChild(inner);

  (sim?.config?.paragraphs || []).forEach((para) => {
    const section = document.createElement("div");
    section.style.marginBottom = "12px";

    const pTitle = document.createElement("div");
    pTitle.innerText = para.title;
    pTitle.style.color = "#00e0ff";
    pTitle.style.fontWeight = "bold";
    pTitle.style.cursor = "pointer";

    const body = document.createElement("div");
    body.innerText = para.body;
    body.style.display = "none";
    body.style.color = "#ccc";
    body.style.fontSize = "13px";

    pTitle.onclick = () => {
      body.style.display = body.style.display === "none" ? "block" : "none";
    };

    section.appendChild(pTitle);
    section.appendChild(body);
    inner.appendChild(section);
  });

  return container;
}

  
function renderCauseEffectSimulation(sim) {
  const container = document.createElement("div");
  container.style.border = "1px solid #333";
  container.style.borderRadius = "12px";
  container.style.padding = "15px";
  container.style.background = "#111";
  container.style.marginTop = "15px";

  const title = document.createElement("h4");
  title.innerHTML = sim.title || "üß± Cause-Effect Simulation";
  title.style.color = "#00e0ff";
  container.appendChild(title);

  const desc = document.createElement("p");
  desc.innerText = sim.description || "Explore how causes lead to effects.";
  desc.style.color = "#ccc";
  desc.style.fontSize = "14px";
  container.appendChild(desc);

  const graph = document.createElement("div");
  graph.style.display = "flex";
  graph.style.flexDirection = "column";
  graph.style.alignItems = "center";
  graph.style.marginTop = "10px";
  container.appendChild(graph);

  // Render nodes and arrows
  sim.config.links.forEach(link => {
    const fromNode = sim.config.nodes.find(n => n.id === link.from);
    const toNode = sim.config.nodes.find(n => n.id === link.to);
    if (!fromNode || !toNode) return;

    const fromEl = document.createElement("div");
    fromEl.innerText = fromNode.text;
    fromEl.style.padding = "10px 15px";
    fromEl.style.marginBottom = "5px";
    fromEl.style.borderRadius = "8px";
    fromEl.style.background = "#1e1e1e";
    fromEl.style.color = "#fff";
    fromEl.style.border = "1px solid #00e0ff";
    fromEl.style.boxShadow = "0 0 8px #00e0ff";
    graph.appendChild(fromEl);

    const arrow = document.createElement("div");
    arrow.innerText = "‚Üì";
    arrow.style.fontSize = "24px";
    arrow.style.color = "#00e0ff";
    arrow.style.margin = "5px 0";
    graph.appendChild(arrow);
  });

  // Add final node if needed
  const lastLink = sim.config.links[sim.config.links.length - 1];
  const lastNode = sim.config.nodes.find(n => n.id === lastLink.to);
  if (lastNode) {
    const final = document.createElement("div");
    final.innerText = lastNode.text;
    final.style.padding = "10px 15px";
    final.style.borderRadius = "8px";
    final.style.background = "#1e1e1e";
    final.style.color = "#fff";
    final.style.border = "1px solid #00e0ff";
    final.style.boxShadow = "0 0 8px #00e0ff";
    graph.appendChild(final);
  }

  return container;
}
function renderAnimatedMapSimulation(simulation) {
  const container = document.createElement("div");
  container.className = "animated-map";
  container.style.border = "1px solid #00e0ff";
  container.style.borderRadius = "12px";
  container.style.padding = "16px";
  container.style.background = "#111";
  container.style.color = "#eee";
  container.style.marginTop = "10px";

  const title = document.createElement("h4");
  title.style.color = "#00e0ff";
  title.innerText = simulation.title || "üó∫Ô∏è Animated Map Simulation";
  container.appendChild(title);

  const desc = document.createElement("p");
  desc.innerText = simulation.description || "";
  desc.style.marginBottom = "10px";
  container.appendChild(desc);

  const yearSelect = document.createElement("select");
  const years = simulation.config?.years || [];
  years.forEach((year, i) => {
    const opt = document.createElement("option");
    opt.value = i;
    opt.innerText = year;
    yearSelect.appendChild(opt);
  });
  container.appendChild(yearSelect);

  const mapBox = document.createElement("div");
  mapBox.style.marginTop = "12px";
  container.appendChild(mapBox);

  function renderYear(index) {
    mapBox.innerHTML = "";
    const values = simulation.config?.mapRegions || {};
    Object.keys(values).forEach(region => {
      const row = document.createElement("div");
      row.style.marginBottom = "8px";
      row.innerHTML = `
        <strong style="color:#00e0ff;">${region}:</strong> 
        ${"üü£".repeat(Math.min(10, Math.floor(values[region][index] / 10)))} 
        <span style="color:#ccc;"> ${values[region][index]}M</span>
      `;
      mapBox.appendChild(row);
    });
  }

  yearSelect.onchange = (e) => {
    renderYear(parseInt(e.target.value));
  };

  // Default render
  renderYear(0);

  return container;
}

function renderNarrativeSimulation(simulation) {
  const container = document.createElement("div");
  container.className = "narrative-sim";
  container.style.border = "1px solid #00e0ff";
  container.style.borderRadius = "12px";
  container.style.padding = "16px";
  container.style.background = "#111";
  container.style.color = "#eee";
  container.style.marginTop = "10px";
  container.style.transition = "opacity 0.5s ease-in-out";

  const title = document.createElement("h4");
  title.innerHTML = simulation.title || "üé≠ Narrative Simulation";
  title.style.color = "#00e0ff";
  container.appendChild(title);

  const state = {
    stepIndex: 0,
    steps: simulation.config?.steps || [],
    pathSummary: "",
    summaryEl: null,
  };

  async function askAIWhatItMeans() {
    if (!state.pathSummary) return;
    state.summaryEl.innerHTML += `<p style="color:#00e0ff;">ü§ñ Asking AI for insights...</p>`;
    try {
      const response = await fetch("https://the-ark-ai-server.onrender.com/explain-simulation-path", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ summary: state.pathSummary })
      });
      const data = await response.json();
      state.summaryEl.innerHTML += `<p style="margin-top:10px; color:#ccc;">üí° <strong>AI explains:</strong><br>${data.explanation}</p>`;
    } catch (err) {
      state.summaryEl.innerHTML += `<p style="color:red;">‚ùå Failed to contact AI</p>`;
    }
  }

  function showStep() {
    container.style.opacity = 0;
    setTimeout(() => {
      container.innerHTML = "";
      container.appendChild(title);
      const currentStep = state.steps[state.stepIndex];

      if (!currentStep) {
        const summaryBox = document.createElement("div");
        summaryBox.style.marginTop = "10px";
        summaryBox.style.padding = "12px";
        summaryBox.style.border = "1px dashed #0f0";
        summaryBox.style.borderRadius = "10px";
        summaryBox.style.background = "#191919";

        state.summaryEl = summaryBox;
        summaryBox.innerHTML = `
          <strong style="color:#0f0;">‚úÖ Summary of your journey:</strong>
          <p style="margin-top:6px;">${state.pathSummary || "You reached the end."}</p>

          <button class="btn" onclick="navigator.clipboard.writeText('${state.pathSummary}')">üì§ Copy Summary</button>
          <button class="btn" style="margin-left:10px;" onclick="(${askAIWhatItMeans.toString()})()">ü§ñ What does it mean?</button>
        `;

        container.appendChild(summaryBox);
        container.style.opacity = 1;
        return;
      }

      const prompt = document.createElement("p");
      prompt.innerText = currentStep.prompt;
      prompt.style.marginBottom = "12px";
      container.appendChild(prompt);

      currentStep.options.forEach(option => {
        const btn = document.createElement("button");
        btn.innerText = option.label;
        btn.className = "btn";
        btn.style.margin = "5px 10px 5px 0";
        btn.onclick = () => {
          if (option.next === "end") {
            state.stepIndex = -1;
            state.pathSummary = option.summary || "You reached the end.";
          } else {
            state.stepIndex = option.next;
          }
          showStep();
        };
        container.appendChild(btn);
      });

      container.style.opacity = 1;
    }, 300);
  }

  showStep();
  return container;
}
  
function simulateNarrativeChoice(simId, choices) {
  const radios = document.querySelectorAll(`input[name='${simId}-choice']`);
  const resultDiv = document.getElementById(`${simId}-result`);
  let selected = null;

  radios.forEach((r, i) => {
    if (r.checked) selected = i;
  });

  if (selected === null) {
    resultDiv.innerHTML = `<p style="color: red;">‚ö†Ô∏è Please select an option first.</p>`;
    return;
  }

  const choice = choices[selected];
  resultDiv.innerHTML = `
    <div style="margin-top: 10px; background: #1a1a1a; padding: 10px; border-radius: 8px;">
      <p><strong>‚úÖ You chose:</strong> ${choice.label}</p>
      <p><strong>üìú Outcome:</strong> ${choice.outcome}</p>
      <p style="color:#ccc;"><em>${choice.summary}</em></p>
    </div>
  `;
}

</script>

  
<script>
function closeComplexBuilder() {
  document.getElementById("complex-builder-modal").style.display = "none";
}
</script>
  


<!-- ‚úÖ Cell Simulation Modal -->
<div id="simulationModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#000000cc; z-index:99999; justify-content:center; align-items:center;">
  <div class="modal-content" style="max-width:600px; overflow-y:auto; max-height:90vh; background:#1a1a1a; padding:20px; border-radius:12px;">
    
    <h3 style="color:#00e0ff;">üîÆ What should this cell do?</h3>

    <textarea id="simulationRequestInput" placeholder="e.g. Compare health systems in Kenya and Finland..." style="width:100%; padding:10px; margin-bottom:10px; background:#111; color:#eee; border:1px solid #00e0ff; border-radius:8px;"></textarea>

    <button class="btn" onclick="askAISimulation()">‚ú® Ask AI</button>

    <p id="simulationStatus" style="color:#00e0ff; font-size:13px; margin:10px 0; display:none;"></p>

    <!-- ‚úÖ New scrollable list of AI simulation suggestions -->
    <div id="ai-sim-suggestion-list" style="max-height: 300px; overflow-y: auto; margin-top: 15px;"></div>

    <button class="btn" onclick="closeSimulationModal()" style="margin-top:15px;">‚ùå Cancel</button>
  </div>
</div>

  
<!-- Calling SImulationModal DOM -->
<div id="simulationModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:9999; justify-content:center; align-items:center;">
  <div class="modal-content" style="max-height:90vh; overflow-y:auto; background:#1a1a1a; padding:20px; border-radius:12px;">
    
    <h3 style="color:#00e0ff;">ü§ñ Ask AI for a Simulation</h3>

    <input id="simulationRequestInput" type="text" placeholder="e.g. simulate education policy impact..." 
      style="width:100%; margin-bottom:10px; padding:10px; border-radius:6px; background:#111; color:#eee; border:1px solid #00e0ff;" />

    <button class="btn" onclick="askAISimulation()">‚ú® Ask AI</button>

    <p id="simulationStatus" style="color:#00e0ff; margin-top:10px; display:none;"></p>

    <!-- ‚úÖ Add this inside the one modal you're keeping -->
    <div id="ai-sim-suggestion-list" style="max-height: 300px; overflow-y: auto; margin-top: 15px;"></div>

    <button class="btn" style="margin-top:20px;" onclick="closeSimulationModal()">‚ùå Close</button>
  </div>
</div>

<script>
window.askAISimulation = async function () {
  const inputEl = document.getElementById("simulationRequestInput");
  const statusEl = document.getElementById("simulationStatus");
  const suggestionList = document.getElementById("ai-sim-suggestion-list");

  if (!inputEl || !statusEl || !suggestionList) {
    console.error("‚ùå Missing required elements in the DOM.");
    return;
  }

  const input = inputEl.value.trim();
  if (!input) return alert("Please enter a request.");

  statusEl.innerHTML = "‚è≥ Asking AI...";
  statusEl.style.display = "block";
  suggestionList.innerHTML = "";

  try {
    const res = await fetch("https://the-ark-ai-server.onrender.com/generate-cell-simulation", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ request: input })
    });

    const data = await res.json();

    if (data.error) {
      statusEl.innerHTML = `‚ùå Error: ${data.error}`;
      return;
    }

    statusEl.style.display = "none";
    showAISuggestions(data.suggestions);

  } catch (err) {
    statusEl.innerHTML = `‚ùå Failed to contact AI server.`;
    console.error("AI Simulation Error:", err);
  }
};
</script>

   
</body>
</html>

