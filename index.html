<!-- ‚¨áÔ∏è START OF FULL CODE -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>The Ark</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-firestore-compat.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #0a0a0a;
      color: white;
      padding: 20px;
      margin-bottom: 70px;
    }
    .btn {
      background: linear-gradient(135deg, #1a73e8, #00e0ff);
      color: white;
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 10px;
      margin-top: 20px;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.3s ease;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(0, 224, 255, 0.4);
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .bottom-nav {
      position: fixed;
      bottom: 0; left: 0;
      width: 100%;
      background: #121212;
      display: flex;
      justify-content: space-around;
      border-top: 1px solid #333;
      z-index: 10000;
    }
    .bottom-nav button {
      flex: 1;
      background: none;
      color: white;
      padding: 12px 0;
      font-size: 14px;
      border: none;
    }
    .community-card {
      background: linear-gradient(135deg, #1a1a1a, #0e0e0e);
      border: 1px solid #333;
      border-radius: 14px;
      padding: 18px;
      margin-top: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.4);
      transition: transform 0.2s ease, box-shadow 0.3s ease;
      cursor: pointer;
    }
    .community-card:hover {
      transform: scale(1.02);
      box-shadow: 0 0 15px rgba(0, 224, 255, 0.2);
    }
    .community-card h3 { color: #00e0ff; margin-bottom: 6px; }
    .community-card p { font-size: 14px; color: #ccc; }

    #community-modal,
    #detail-modal,
    #cell-modal,
    #add-cell-modal,
    #add-complex-modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: rgba(0, 0, 0, 0.85);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: #1c1c1c;
      color: white;
      padding: 24px;
      border-radius: 14px;
      width: 90%;
      max-width: 420px;
    }

    .modal-content input,
    .modal-content textarea {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      background: #121212;
      color: white;
      border-radius: 6px;
      border: 1px solid #333;
    }

    #complex-feed {
      margin-top: 20px;
      background: #111;
      padding: 16px;
      border-radius: 12px;
      border: 1px dashed #333;
      color: #999;
      text-align: center;
    }
  </style>
</head>
<body>

<!-- TABS -->
<div id="home" class="tab-content active">
  <h1>üåä Welcome to The Ark</h1>
  <p id="welcome-message">Hello, guest!</p>
</div>

<div id="communities" class="tab-content">
  <h2>üåê Explore Communities</h2>
  <button class="btn" onclick="openCommunityModal()">+ Join or Create</button>
  <button class="btn" onclick="toggleCommunityView()" id="toggle-view-btn">Show All Communities</button>
  <div id="community-list" style="margin-top:30px;"></div>
</div>

<div id="my-communities" class="tab-content">
  <h2>üìÅ My Communities</h2>
  <div id="my-community-list" style="margin-top:30px;"></div>
</div>

<div id="profile" class="tab-content">
  <h2>üë§ Profile</h2>
  <p>Your info and settings will appear here.</p>
</div>

<!-- NAVIGATION BAR -->
<div class="bottom-nav">
  <button onclick="showTab('home')">üè†</button>
  <button onclick="showTab('communities')">üåê</button>
  <button onclick="showTab('my-communities'); loadMyCommunities()">üß¨</button>
  <button onclick="showTab('profile')">üë§</button>
</div>

<!-- COMMUNITY MODALS -->
<div id="community-modal">
  <div class="modal-content">
    <h2>Create a Community</h2>
    <input id="community-name" type="text" placeholder="Community Name" />
    <textarea id="community-summary" placeholder="Short Summary (optional)"></textarea>
    <button class="btn" onclick="submitCommunity()">Create</button>
    <button class="btn" style="background:#444;" onclick="closeCommunityModal()">Cancel</button>
  </div>
</div>

<div id="detail-modal">
  <div class="modal-content">
    <h2 id="detail-name">Community Name</h2>
    <p id="detail-summary">Summary here</p>
    <button class="btn" onclick="openAddComplexModal()">‚ûï Create Complex</button>
    <div id="complex-feed">üì¶ Complex feed coming soon...</div>
    <button class="btn" onclick="closeDetailModal()">Close</button>
  </div>
</div>

<!-- COMPLEX + CELL MODALS -->
<div id="add-complex-modal" class="modal-content" style="display:none;">
  <div class="modal-content">
    <h2>Create a Complex</h2>
    <input id="complex-title" type="text" placeholder="Complex Name" />
    <textarea id="complex-summary" placeholder="Short Summary"></textarea>
    <button class="btn" onclick="submitComplex()">Create</button>
    <button class="btn" style="background:#444;" onclick="closeAddComplexModal()">Cancel</button>
  </div>
</div>

<div id="cell-modal" class="modal-content" style="display:none;">
  <div class="modal-content">
    <h2 id="cell-modal-title">Cells in Complex</h2>
    <div id="cell-list"></div>
    <button class="btn" onclick="openAddCellModal()">‚ûï Add Cell</button>
    <button class="btn" onclick="closeCellModal()">Close</button>
  </div>
</div>

<div id="add-cell-modal" class="modal-content" style="display:none;">
  <div class="modal-content">
    <h2>Add a Cell</h2>
    <input id="cell-title" type="text" placeholder="Cell Title" />
    <textarea id="cell-content" placeholder="Content or Summary"></textarea>
    <button class="btn" onclick="submitCell()">Add</button>
    <button class="btn" style="background:#444;" onclick="closeAddCellModal()">Cancel</button>
  </div>
</div>

<!-- SCRIPT -->
<script>
  const tg = window.Telegram.WebApp;
  const userInfo = tg?.initDataUnsafe?.user;
  const user = userInfo?.first_name || "guest";
  document.getElementById("welcome-message").innerText = `Hello, ${user}!`;

  const firebaseConfig = {
    apiKey: "AIzaSyBCU2YmXwyT1v5kmUp1HRyUqEQ8eY0n73M",
    authDomain: "the-ark-app-7bf83.firebaseapp.com",
    projectId: "the-ark-app-7bf83",
    storageBucket: "the-ark-app-7bf83.appspot.com",
    messagingSenderId: "838041964191",
    appId: "1:838041964191:web:a91e9555e62d81f2ee84aa"
  };

  const app = firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  if (userInfo) {
    const userRef = db.collection("users").doc(userInfo.id.toString());
    userRef.get().then(doc => {
      if (!doc.exists) {
        userRef.set({
          telegramId: userInfo.id,
          firstName: userInfo.first_name,
          createdAt: new Date()
        });
      }
    });
  }

  let showAll = false;
  let currentCommunityId = null;
  let currentComplexId = null;

  function showTab(id) {
    document.querySelectorAll(".tab-content").forEach(el => el.classList.remove("active"));
    document.getElementById(id).classList.add("active");
  }

  function openCommunityModal() {
    document.getElementById("community-modal").style.display = "flex";
  }
  function closeCommunityModal() {
    document.getElementById("community-modal").style.display = "none";
  }

  function openAddComplexModal() {
    document.getElementById("add-complex-modal").style.display = "flex";
  }
  function closeAddComplexModal() {
    document.getElementById("add-complex-modal").style.display = "none";
  }

  function openAddCellModal() {
    document.getElementById("add-cell-modal").style.display = "flex";
  }
  function closeAddCellModal() {
    document.getElementById("add-cell-modal").style.display = "none";
  }

  function submitCommunity() {
    const name = document.getElementById("community-name").value.trim();
    const summary = document.getElementById("community-summary").value.trim();
    if (!name) return alert("Name required");
    db.collection("communities").add({
      name, summary,
      createdBy: userInfo?.id || "anon",
      members: [userInfo?.id],
      createdAt: new Date()
    }).then(() => {
      alert("‚úÖ Community created!");
      closeCommunityModal();
    });
  }

  function renderCommunityCard(doc) {
    const data = doc.data();
    data.id = doc.id;
    const hasJoined = data.members?.includes(userInfo.id);
    if (!showAll && !hasJoined) return;
    const card = document.createElement("div");
    card.className = "community-card";
    card.innerHTML = `<h3>üìò ${data.name}</h3><p>${data.summary || "No summary"}</p>`;
    card.onclick = () => openDetailModal(data);
    document.getElementById("community-list").appendChild(card);
  }

  function openDetailModal(data) {
    const feed = document.getElementById("complex-feed");
    const detailModal = document.getElementById("detail-modal");

    currentCommunityId = data.id;
    document.getElementById("detail-name").innerText = `üìò ${data.name}`;
    document.getElementById("detail-summary").innerText = data.summary || "No summary provided.";
    detailModal.style.display = "flex";

    // Reset the feed container
    feed.innerHTML = "<p>Loading complexes...</p>";

    // Add "Create Complex" button
    const createBtn = document.createElement("button");
    createBtn.className = "btn";
    createBtn.innerText = "‚ûï Create Complex";
    createBtn.onclick = openAddComplexModal;
    feed.before(createBtn); // place above feed

    // Load and show existing complexes
    db.collection("complexes")
      .where("communityId", "==", data.id)
      .get()
      .then((snapshot) => {
        if (snapshot.empty) {
          feed.innerHTML = "<p>No complexes yet.</p>";
          return;
        }

        feed.innerHTML = "";
        snapshot.forEach((doc) => {
          const complex = doc.data();
          const box = document.createElement("div");
          box.className = "community-card";
          box.innerHTML = `
            <h3>üß† ${complex.name}</h3>
            <p>${complex.summary || "No summary."}</p>
            <button class="btn" onclick='openCellModal(${JSON.stringify(complex).replace(/"/g, "&quot;")}, "${doc.id}")'>Enter Complex</button>
          `;
          feed.appendChild(box);
        });
      });
  }

  function closeDetailModal() {
    document.getElementById("detail-modal").style.display = "none";
  }

  function submitComplex() {
    const name = document.getElementById("complex-title").value.trim();
    const summary = document.getElementById("complex-summary").value.trim();
    if (!name || !currentCommunityId) return alert("Enter name and be inside a community");
    db.collection("complexes").add({
      name, summary,
      communityId: currentCommunityId,
      createdAt: new Date(),
      cells: []
    }).then(() => {
      alert("‚úÖ Complex created!");
      closeAddComplexModal();
      openDetailModal({ id: currentCommunityId });
    });
  }

  function openCellModal(complex, complexId) {
    currentComplexId = complexId;
    document.getElementById("cell-modal-title").innerText = `üß† ${complex.name}`;
    const list = document.getElementById("cell-list");
    list.innerHTML = "";
    if (complex.cells?.length) {
      complex.cells.forEach(cell => {
        const div = document.createElement("div");
        div.className = "community-card";
        div.innerHTML = `<h4>üìÑ ${cell.title}</h4><p>${cell.content || ""}</p>`;
        list.appendChild(div);
      });
    } else {
      list.innerHTML = "<p>No cells yet.</p>";
    }
    document.getElementById("cell-modal").style.display = "flex";
  }

  function closeCellModal() {
    document.getElementById("cell-modal").style.display = "none";
  }

  function submitCell() {
    const title = document.getElementById("cell-title").value.trim();
    const content = document.getElementById("cell-content").value.trim();
    if (!title || !currentComplexId) return alert("Please enter a title");
    const newCell = { title, content };
    const ref = db.collection("complexes").doc(currentComplexId);
    ref.update({
      cells: firebase.firestore.FieldValue.arrayUnion(newCell)
    }).then(() => {
      alert("‚úÖ Cell added!");
      closeAddCellModal();
    });
  }

  function toggleCommunityView() {
    showAll = !showAll;
    document.getElementById("toggle-view-btn").innerText = showAll ? "Show My Communities" : "Show All Communities";
    loadCommunities();
  }

  function loadCommunities() {
    db.collection("communities").onSnapshot(snapshot => {
      const container = document.getElementById("community-list");
      container.innerHTML = "";
      snapshot.forEach(doc => renderCommunityCard(doc));
    });
  }

  function loadMyCommunities() {
    db.collection("communities").where("members", "array-contains", userInfo.id).onSnapshot(snapshot => {
      const container = document.getElementById("my-community-list");
      container.innerHTML = "";
      snapshot.forEach(doc => renderCommunityCard(doc));
    });
  }

  loadCommunities();
</script>
</body>
</html>
<!-- ‚¨ÜÔ∏è END OF FULL CODE -->


