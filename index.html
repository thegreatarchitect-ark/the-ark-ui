<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>The Ark</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-firestore-compat.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #0a0a0a;
      color: white;
      padding: 20px;
      margin-bottom: 70px;
    }
    .btn {
      background: linear-gradient(135deg, #1a73e8, #00e0ff);
      color: white;
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 10px;
      margin-top: 20px;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.3s ease;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(0, 224, 255, 0.4);
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: #121212;
      display: flex;
      justify-content: space-around;
      border-top: 1px solid #333;
      z-index: 10000;
    }
    .bottom-nav button {
      flex: 1;
      background: none;
      color: white;
      padding: 12px 0;
      font-size: 14px;
      border: none;
    }
    .community-card {
      background: linear-gradient(135deg, #1a1a1a, #0e0e0e);
      border: 1px solid #333;
      border-radius: 14px;
      padding: 18px;
      margin-top: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.4);
      transition: transform 0.2s ease, box-shadow 0.3s ease;
      cursor: pointer;
    }
    .community-card:hover {
      transform: scale(1.02);
      box-shadow: 0 0 15px rgba(0, 224, 255, 0.2);
    }
    .community-card h3 {
      color: #00e0ff;
      margin-bottom: 6px;
    }
    .community-card p {
      font-size: 14px;
      color: #ccc;
    }
    #community-modal,
    #detail-modal,
    #add-complex-modal,
    #cell-modal,
    #add-cell-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.85);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: #1c1c1c;
      color: white;
      padding: 24px;
      border-radius: 14px;
      width: 90%;
      max-width: 420px;
    }
    .modal-content input,
    .modal-content textarea {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      margin-bottom: 10px;
      background: #121212;
      color: white;
      border-radius: 6px;
      border: 1px solid #333;
    }
    #complex-feed {
      margin-top: 20px;
      background: #111;
      padding: 16px;
      border-radius: 12px;
      border: 1px dashed #333;
      color: #999;
      text-align: center;
    }
    .tag-badge {
      display: inline-block;
      background: #1a1a1a;
      border: 1px solid #00e0ff;
      color: #00e0ff;
      padding: 4px 10px;
      margin: 4px 4px 0 0;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }

    .profile-section {
      margin-top: 30px;
      background: #111;
      border-radius: 12px;
      padding: 16px;
      border: 1px solid #333;
    }
    
  </style>
  <style>
    .complex-card {
      background: linear-gradient(180deg, #101010, #0a0a0a);
      border: 2px solid #00e0ff;
      border-radius: 20px;
      padding: 24px;
      margin: 20px auto;
      max-width: 380px;
      height: 460px;
      box-shadow: 0 0 25px rgba(0, 224, 255, 0.2);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      transition: transform 0.2s ease, box-shadow 0.3s ease;
    }

    .complex-card h2 {
      color: #00e0ff;
      font-size: 20px;
      text-align: center;
      margin-bottom: 12px;
    }

    .complex-summary {
      color: #ccc;
      font-size: 14px;
      text-align: center;
      flex-grow: 1;
      overflow-y: auto;
      padding: 0 10px;
      max-height: 200px;
    }

    .complex-buttons {
      display: flex;
      justify-content: space-around;
      margin-top: 20px;
    }

    .btn-complex,
    .btn-outline {
      padding: 8px 12px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: bold;
      white-space: nowrap;
      max-width: 48%;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .btn-complex {
      background-color: #00e0ff;
      color: #000;
      border: none;
    }

    .btn-outline {
      background: none;
      border: 1px solid #00e0ff;
      color: #00e0ff;
    }

    .btn-complex:hover,
    .btn-outline:hover {
      transform: translateY(-2px);
      box-shadow: 0 0 12px rgba(0, 224, 255, 0.4);
    }
  </style>

</head>
<body>

  <!-- TABS -->
  <div id="home" class="tab-content active" style="position: relative;">
    <!-- Standalone Complex Button -->
    <button class="btn" style="
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 13px;
      padding: 8px 16px;
      z-index: 10;
      background: linear-gradient(135deg, #00e0ff, #1a73e8);
      border-radius: 12px;
    " onclick="openStandaloneComplexModal()">‚ûï Create Standalone Complex</button>

    <!-- Featured Complexes -->
    <h2 style="margin-top: 60px;">üì¶ Featured Complexes</h2>
    <div id="home-complex-list" style="margin-top: 20px;"></div>

    <!-- Recommended Feed -->
    <h2 style="margin-top: 40px;">üîç Recommended for You</h2>
    <ul style="padding-left: 20px; color: #ccc; font-size: 14px;">
      <li>üß† AI in Healthcare</li>
      <li>üåç Climate Policy Scenarios</li>
      <li>ü™ô Bitcoin‚Äôs Energy Impact</li>
    </ul>
  </div>


 


  <div id="research" class="tab-content"><h2>üîç Research</h2><p>Coming soon‚Ä¶</p></div>

  <div id="communities" class="tab-content">
    <h2>üåê Explore Communities</h2>

    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
      <button class="btn" onclick="openCommunityModal()">+ Join or Create</button>
    
      <select id="community-sort" class="btn" style="background:#222; border:1px solid #333;" onchange="loadCommunities()">
        <option value="newest">üÜï Newest</option>
        <option value="members">üë• Most Members</option>
      </select>

      <button class="btn" onclick="toggleCommunityView()" id="toggle-view-btn">Show All Communities</button>
    </div>

    <div id="community-list" style="margin-top:30px;"></div>
  </div>


  <div id="my-communities" class="tab-content">
    <h2>üìÅ My Communities</h2>

    <h3>üëë Communities You Created</h3>
    <div id="created-community-list" style="margin-bottom: 40px;"></div>

    <h3>üß¨ Communities You Joined</h3>
    <div id="joined-community-list"></div>
  </div>

  <div id="profile" class="tab-content">
    <!-- üë§ User Profile Header -->
    <div style="text-align: center; margin-bottom: 20px;">
      <img id="profile-photo" src="" alt="Profile Photo" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 2px solid #00e0ff;" />
      <h2 id="profile-name" style="margin-top: 10px;">üë§ Username</h2>
      <p id="profile-bio" style="color: #aaa; font-size: 14px;">Click to add your bio</p>
      <p id="user-stats" style="color: #ccc; margin-top: 10px;">Loading...</p>
    </div>

    <!-- üß≠ Tab Navigation -->
    <div style="display: flex; justify-content: center; gap: 20px; margin: 20px 0;">
      <button class="btn" id="tab-communities" onclick="showProfileTab('communities')">ü´Ç Communities</button>
      <button class="btn" id="tab-complexes" onclick="showProfileTab('complexes')">üß† Complexes</button>
      <button class="btn" id="tab-featured" onclick="showProfileTab('featured')">‚≠ê Featured</button>
    </div>


    <!-- üìÇ Content Sections (toggle based on tab) -->

    <!-- COMMUNITIES TAB -->
    <div id="profile-communities" class="profile-section-tab">
      <div class="profile-section">
        <h3>üëë Communities You Created</h3>
        <div id="user-created-communities"></div>
      </div>

      <div class="profile-section">
        <h3>üß¨ Communities You Joined</h3>
        <div id="user-joined-communities"></div>
      </div>
    </div>

    <!-- COMPLEXES TAB -->
    <div id="profile-complexes" class="profile-section-tab" style="display: none;">
      <div class="profile-section">
        <h3>üì¶ Complexes You Created</h3>
        <div id="user-complexes"></div>
      </div>

      <div class="profile-section">
        <h3>üåê Complexes in Communities</h3>
        <div id="user-community-complexes">Coming soon...</div>
      </div>
    </div>
  </div>





  
  <!-- Modals -->
  <div id="community-modal">
    <div class="modal-content">
      <h2>Create a Community</h2>
      <input id="community-name" type="text" placeholder="Community Name" />
      <textarea id="community-summary" placeholder="Short Summary (optional)"></textarea>
      <input id="community-tags" type="text" placeholder="Tags (comma separated, e.g. ai,health,data)" />
      <button class="btn" onclick="submitCommunity()">Create</button>
      <button class="btn" style="background:#444; margin-left:10px;" onclick="closeCommunityModal()">Cancel</button>
    </div>
  </div>


  <div id="detail-modal">
    <div class="modal-content" style="display: flex; flex-direction: column; max-height: 90vh; overflow: hidden;">
      <h2 id="detail-name">Community Name</h2>
      <p id="detail-summary">Summary will appear here.</p>

    <!-- Sticky Buttons Container -->
      <div style="margin-bottom: 10px;">
        <button class="btn" onclick="openAddComplexModal()">‚ûï Create Complex</button>
      </div>

    <!-- Scrollable Complex List -->
      <div id="complex-feed" style="flex: 1; overflow-y: auto; padding: 10px; border: 1px dashed #333; background: #111; border-radius: 12px; margin-bottom: 10px;">
      üì¶ Complex feed coming soon...
      </div>

    <!-- Sticky Close Button -->
      <div style="margin-top: auto;">
        <button class="btn" onclick="closeDetailModal()">Close</button>
      </div>
    </div>
  </div>


  <div id="add-complex-modal">
    <div class="modal-content">
      <h2>Create a Complex</h2>
      <input id="complex-title" type="text" placeholder="Complex Name" />
      <textarea id="complex-summary" placeholder="Short Summary"></textarea>
      <button class="btn" onclick="submitComplex()">Create</button>
      <button class="btn" style="background:#444; margin-left:10px;" onclick="closeAddComplexModal()">Cancel</button>
    </div>
  </div>

  <div id="cell-modal">
    <div class="modal-content">
      <h2 id="cell-modal-title">Cells in Complex</h2>
      <div id="cell-list"></div>
      <button class="btn" onclick="openAddCellModal()">‚ûï Add Cell</button>
      <button class="btn" onclick="closeCellModal()">Close</button>
    </div>
  </div>

  <div id="add-cell-modal">
    <div class="modal-content">
      <h2>Add a Cell</h2>
      <input id="cell-title" type="text" placeholder="Cell Title" />
      <textarea id="cell-content" placeholder="Content or Summary"></textarea>
      <button class="btn" onclick="submitCell()">Add</button>
      <button class="btn" style="background:#444; margin-left:10px;" onclick="closeAddCellModal()">Cancel</button>
    </div>
  </div>

  <div id="standalone-complex-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.85); z-index:9999; justify-content:center; align-items:center;">
    <div class="modal-content">
      <h2>Create Standalone Complex</h2>
      <input id="standalone-title" type="text" placeholder="Complex Title" />
      <textarea id="standalone-summary" placeholder="Short Summary"></textarea>
    
      <h3>‚ûï Add a Cell</h3>
      <input id="standalone-cell-title" type="text" placeholder="Cell Title" />
      <textarea id="standalone-cell-content" placeholder="Cell Content"></textarea>

      <button class="btn" onclick="submitStandaloneComplex()">‚úÖ Save Complex</button>
      <button class="btn" style="background:#444; margin-left:10px;" onclick="closeStandaloneComplexModal()">Cancel</button>
    </div>
  </div>

  <!-- Complex Builder Modal (Step-by-Step) -->
<div id="complex-builder-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.85); z-index:9999; justify-content:center; align-items:center;">
  <div class="modal-content">
    <h2 id="builder-step-title">Step 1: Create Complex</h2>

    <!-- Step 1: Title + Summary -->
    <div id="step-1">
      <input id="builder-title" type="text" placeholder="Complex Title" />
      <textarea id="builder-summary" placeholder="Short Summary"></textarea>
      <button class="btn" onclick="goToStep(2)">Next ‚û°Ô∏è</button>
    </div>

    <!-- Step 2: Add Cells -->
    <div id="step-2" style="display:none">
      <input id="cell-temp-title" type="text" placeholder="Cell Title" />
      <textarea id="cell-temp-content" placeholder="Cell Content"></textarea>
      <button class="btn" onclick="addCellToBuilder()">‚ûï Add Cell</button>
      <div id="cell-preview-list" style="margin-top:20px;"></div>
      <button class="btn" onclick="goToStep(3)">Next ‚û°Ô∏è</button>
      <button class="btn" style="background:#444; margin-left:10px;" onclick="goToStep(1)">‚¨ÖÔ∏è Back</button>
    </div>

    <!-- Step 3: Review & Save -->
    <div id="step-3" style="display:none">
      <h3>üìò Complex Preview</h3>
      <p><strong>Title:</strong> <span id="preview-title"></span></p>
      <p><strong>Summary:</strong> <span id="preview-summary"></span></p>
      <div id="preview-cells" style="margin-top:10px;"></div>
      <button class="btn" onclick="submitComplexBuilder()">‚úÖ Save Complex</button>
      <button class="btn" style="background:#444; margin-left:10px;" onclick="goToStep(2)">‚¨ÖÔ∏è Back</button>
    </div>

    <button class="btn" style="background:#222; margin-top:20px;" onclick="closeComplexBuilder()">Cancel</button>
  </div>
</div>

<!-- Add style for scrollable complex list and fix modal scrolling issues -->
<style>
  #complex-feed {
    margin-top: 20px;
    background: #111;
    padding: 16px;
    border-radius: 12px;
    border: 1px dashed #333;
    color: #999;
    text-align: center;
    max-height: 300px;
    overflow-y: auto;
  }
</style>

<script>
  let newComplexCells = [];
  let currentBuilderStep = 1;

  function openComplexBuilderModal() {
    newComplexCells = [];
    currentBuilderStep = 1;
    document.getElementById("builder-title").value = "";
    document.getElementById("builder-summary").value = "";
    document.getElementById("cell-temp-title").value = "";
    document.getElementById("cell-temp-content").value = "";
    document.getElementById("preview-cells").innerHTML = "";
    goToStep(1);
    document.getElementById("complex-builder-modal").style.display = "flex";
  }

  function closeComplexBuilder() {
    document.getElementById("complex-builder-modal").style.display = "none";
  }

  function goToStep(step) {
    currentBuilderStep = step;
    document.getElementById("builder-step-title").innerText = `Step ${step}: ${step === 1 ? "Create Complex" : step === 2 ? "Add Cells" : "Review"}`;
    document.getElementById("step-1").style.display = step === 1 ? "block" : "none";
    document.getElementById("step-2").style.display = step === 2 ? "block" : "none";
    document.getElementById("step-3").style.display = step === 3 ? "block" : "none";

    if (step === 3) {
      document.getElementById("preview-title").innerText = document.getElementById("builder-title").value;
      document.getElementById("preview-summary").innerText = document.getElementById("builder-summary").value;
      const preview = document.getElementById("preview-cells");
      preview.innerHTML = "";
      newComplexCells.forEach((cell, index) => {
        const div = document.createElement("div");
        div.className = "community-card";
        div.innerHTML = `<h4>${index + 1}. ${cell.title}</h4><p>${cell.content.slice(0, 80)}...</p>`;
        preview.appendChild(div);
      });
    }
  }

  function addCellToBuilder() {
    const title = document.getElementById("cell-temp-title").value.trim();
    const content = document.getElementById("cell-temp-content").value.trim();
    if (!title || !content) {
      alert("Please fill in both fields.");
      return;
    }
    newComplexCells.push({ title, content });
    document.getElementById("cell-temp-title").value = "";
    document.getElementById("cell-temp-content").value = "";
    renderCellPreviewList();
  }

  function renderCellPreviewList() {
    const container = document.getElementById("cell-preview-list");
    container.innerHTML = "";
    newComplexCells.forEach((cell, index) => {
      const div = document.createElement("div");
      div.className = "community-card";
      div.innerHTML = `<h4>${index + 1}. ${cell.title}</h4><p>${cell.content.slice(0, 80)}...</p>`;
      container.appendChild(div);
    });
  }

  function submitComplexBuilder() {
    const name = document.getElementById("builder-title").value.trim();
    const summary = document.getElementById("builder-summary").value.trim();
    if (!name || !currentCommunityId) {
      alert("Please provide a title and be inside a community.");
      return;
    }
    db.collection("complexes").add({
      name,
      summary,
      communityId: currentCommunityId,
      createdAt: new Date(),
      cells: newComplexCells
      createdBy: userInfo.id
    }).then(() => {
      alert("‚úÖ Complex created!");
      closeComplexBuilder();
      openDetailModal({ id: currentCommunityId, name });
    });
  }

  function closeDetailModal() {
    document.getElementById("detail-modal").style.display = "none";
  }
</script>

<!-- Replace old complex creation trigger -->
<script>
  function openAddComplexModal() {
    openComplexBuilderModal();
  }
</script>




  <!-- Continued from Part 1 -->
  <!-- Modals and Main Content were loaded above -->

  <!-- Bottom Navigation -->
  <div class="bottom-nav">
    <button onclick="showTab('home')">üè†</button>
    <button onclick="showTab('research')">üîç</button>
    <button onclick="showTab('communities')">üåê</button>
    <button onclick="showTab('my-communities'); loadMyCommunities()">üß¨</button>
    <button onclick="showTab('profile'); loadUserProfile()">üë§</button>

  </div>

  <!-- FIREBASE + LOGIC -->
  <script>
    const tg = window.Telegram.WebApp;
    const userInfo = tg?.initDataUnsafe?.user;
    const user = userInfo?.first_name || "guest";
    document.getElementById("welcome-message").innerText = `Hello, ${user}!`;

    const firebaseConfig = {
      apiKey: "AIzaSyBCU2YmXwyT1v5kmUp1HRyUqEQ8eY0n73M",
      authDomain: "the-ark-app-7bf83.firebaseapp.com",
      projectId: "the-ark-app-7bf83",
      storageBucket: "the-ark-app-7bf83.appspot.com",
      messagingSenderId: "838041964191",
      appId: "1:838041964191:web:a91e9555e62d81f2ee84aa"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    if (userInfo) {
      const userRef = db.collection("users").doc(userInfo.id.toString());
      userRef.get().then((doc) => {
        if (!doc.exists) {
          userRef.set({
            telegramId: userInfo.id,
            firstName: userInfo.first_name,
            username: userInfo.username || "",
            photoUrl: userInfo.photo_url || "",
            createdAt: new Date()
          });
        }
      });
    }

    let currentCommunityId = null;
    let currentComplexId = null;
    let currentComplexName = "";
    let showAll = false;

    function showTab(tabId) {
      document.querySelectorAll(".tab-content").forEach(el => el.classList.remove("active"));
      document.getElementById(tabId).classList.add("active");

      if (tabId === "home") {
        loadHomeComplexes();
      }
    }

    function openCommunityModal() {
      document.getElementById("community-modal").style.display = "flex";
    }

    function closeCommunityModal() {
      document.getElementById("community-modal").style.display = "none";
    }

    function openAddComplexModal() {
      document.getElementById("add-complex-modal").style.display = "flex";
    }

    function closeAddComplexModal() {
      document.getElementById("add-complex-modal").style.display = "none";
    }

    function openAddCellModal() {
      document.getElementById("add-cell-modal").style.display = "flex";
    }

    function closeAddCellModal() {
      document.getElementById("add-cell-modal").style.display = "none";
    }

    function closeDetailModal() {
      document.getElementById("detail-modal").style.display = "none";
    }

    
    function openDetailModal(data) {
      currentCommunityId = data.id || data.name;
      document.getElementById("detail-name").innerText = `üìò ${data.name}`;
      document.getElementById("detail-summary").innerText = data.summary || "No summary provided.";
      document.getElementById("detail-modal").style.display = "flex";

      // Remove previous tags if present
      const existingTags = document.getElementById("detail-tags");
      if (existingTags) existingTags.remove();

      // ‚úÖ Display Tags
      const tagsContainer = document.createElement("div");
      tagsContainer.id = "detail-tags";
      tagsContainer.style.margin = "10px 0";

      if (Array.isArray(data.tags)) {
        data.tags.forEach(tag => {
          const tagEl = document.createElement("span");
          tagEl.className = "tag-badge";
          tagEl.innerText = `#${tag}`;
          tagsContainer.appendChild(tagEl);
        });
      }

      // Insert right under the summary
      document.getElementById("detail-summary").insertAdjacentElement("afterend", tagsContainer);

      // Load Complexes
      const feed = document.getElementById("complex-feed");
      feed.innerHTML = "<p>Loading complexes...</p>";

      db.collection("complexes")
        .where("communityId", "==", currentCommunityId)
        .onSnapshot((snapshot) => {
          if (snapshot.empty) {
            feed.innerHTML = "<p>No complexes yet.</p>";
            return;
          }

          feed.innerHTML = "";
          snapshot.forEach((doc) => {
            const complex = { ...doc.data(), id: doc.id }; // ‚úÖ ensure we keep the ID
            const card = document.createElement("div");
            card.className = "complex-card";

            // ‚úÖ Title
            const title = document.createElement("h2");
            title.innerText = `üß† ${complex.name}`;
            title.style.color = "#00e0ff";
            title.style.textAlign = "center";

            // ‚úÖ Summary
            const summary = document.createElement("p");
            summary.innerText = complex.summary || "No summary provided.";
            summary.className = "complex-summary";

            // ‚úÖ Buttons
            const enterBtn = document.createElement("button");
            enterBtn.className = "btn-complex";
            enterBtn.innerText = "üö™ Enter Complex";
            enterBtn.onclick = () => openCellModal(complex, complex.id);

            const shareBtn = document.createElement("button");
            shareBtn.className = "btn-outline";
            shareBtn.innerText = "üîó Share";

            const buttonRow = document.createElement("div");
            buttonRow.className = "complex-buttons";
            buttonRow.appendChild(enterBtn);
            buttonRow.appendChild(shareBtn);

            // ‚úÖ Append everything
            card.appendChild(title);
            card.appendChild(summary);
            card.appendChild(buttonRow);
            feed.appendChild(card);


          });
        });
    }

    function loadHomeComplexes() {
      const container = document.getElementById("home-complex-list");
      container.innerHTML = "<p>Loading featured complexes...</p>";

      db.collection("complexes")
        .where("communityId", "==", null) // Only standalone
        .orderBy("createdAt", "desc")
        .limit(3)
        .onSnapshot(snapshot => {
          // existing rendering code

          container.innerHTML = "";
          snapshot.forEach(doc => {
            const data = doc.data();
            const card = document.createElement("div");
            card.className = "complex-card";
            card.innerHTML = `
              <h2>üß† ${data.name}</h2>
              <p class="complex-summary">${data.summary || "No summary."}</p>
              <div class="complex-buttons">
                <button class="btn-complex" onclick='openCellModal(${JSON.stringify(data).replace(/"/g, "&quot;")}, "${doc.id}")'>üö™ Enter Complex</button>
                <button class="btn-outline">üîó Share</button>
              </div>
            `;
            container.appendChild(card);
          });

          if (container.innerHTML === "") {
            container.innerHTML = "<p>No featured complexes yet.</p>";
          }
        });
    }

    function submitCommunity() {
      const name = document.getElementById("community-name").value.trim();
      const summary = document.getElementById("community-summary").value.trim();
      const tagsInput = document.getElementById("community-tags").value.trim();
      const tags = tagsInput ? tagsInput.split(",").map(t => t.trim()).filter(Boolean) : [];

      if (!name) {
        alert("Please enter a community name.");
        return;
      }
      db.collection("communities").add({
        name,
        summary,
        createdBy: userInfo?.id || "anonymous",
        members: [userInfo?.id],
        memberCount: 1,
        tags,
        createdAt: new Date()
      }).then(() => {
        alert("‚úÖ Community created!");
        closeCommunityModal();
      });
    }

    function submitComplex() {
      const name = document.getElementById("complex-title").value.trim();
      const summary = document.getElementById("complex-summary").value.trim();
      if (!name || !currentCommunityId) {
        alert("Please provide a name and be inside a community.");
        return;
      }
      db.collection("complexes").add({
        name,
        summary,
        communityId: currentCommunityId,
        createdAt: new Date(),
        cells: []
        createdBy: userInfo.id
      }).then(() => {
        alert("‚úÖ Complex created!");
        closeAddComplexModal();
      });
    }

    function openCellModal(complex, complexId) {
      currentComplexId = complexId;
      currentComplexName = complex.name;

      document.getElementById("cell-modal-title").innerText = `üß† ${complex.name}`;
      const list = document.getElementById("cell-list");
      list.innerHTML = "";

      // Main content container with scrolling
      const scrollWrapper = document.createElement("div");
      scrollWrapper.style.maxHeight = "400px";
      scrollWrapper.style.overflowY = "auto";
      scrollWrapper.style.marginBottom = "20px";

      const grid = document.createElement("div");
      grid.style.display = "grid";
      grid.style.gridTemplateColumns = "1fr 1fr";
      grid.style.gap = "10px";
      grid.style.marginTop = "10px";

      if (complex.cells && complex.cells.length) {
        complex.cells.forEach((cell) => {
          const card = document.createElement("div");
          card.style.background = "#111";
          card.style.border = "1px solid #333";
          card.style.borderRadius = "12px";
          card.style.padding = "12px";
          card.style.height = "150px";
          card.style.overflow = "hidden";

          const title = document.createElement("h4");
          title.innerText = `üìÑ ${cell.title}`;
          title.style.color = "#00e0ff";
          title.style.fontSize = "14px";
          title.style.marginBottom = "6px";

          const content = document.createElement("p");
          content.innerText = cell.content?.slice(0, 100) || "No content";
          content.style.fontSize = "12px";
          content.style.color = "#ccc";

          card.appendChild(title);
          card.appendChild(content);
          grid.appendChild(card);
        });
      } else {
        const empty = document.createElement("p");
        empty.innerText = "No cells yet.";
        empty.style.color = "#888";
        grid.appendChild(empty);
      }

      scrollWrapper.appendChild(grid);
      list.appendChild(scrollWrapper);

      // Action Buttons at the bottom
      const actionButtons = document.createElement("div");
      actionButtons.style.display = "flex";
      actionButtons.style.flexDirection = "column";
      actionButtons.style.gap = "10px";
      actionButtons.style.marginTop = "10px";

      const addCellBtn = document.createElement("button");
      addCellBtn.className = "btn";
      addCellBtn.innerText = "‚ûï Add Cell";
      addCellBtn.onclick = openAddCellModal;

      const backBtn = document.createElement("button");
      backBtn.className = "btn";
      backBtn.innerText = "üîô Back to Community";
      backBtn.onclick = () => {
        closeCellModal();
        openDetailModal({ id: currentCommunityId, name: currentComplexName });
      };

      const closeBtn = document.createElement("button");
      closeBtn.className = "btn";
      closeBtn.innerText = "‚ùå Close";
      closeBtn.onclick = closeCellModal;

      actionButtons.appendChild(addCellBtn);
      actionButtons.appendChild(backBtn);
      actionButtons.appendChild(closeBtn);

      list.appendChild(actionButtons);

      // Show modal
      document.getElementById("cell-modal").style.display = "flex";

      // Realtime listener for cells
      db.collection("complexes").doc(currentComplexId).onSnapshot((doc) => {
        const data = doc.data();
        if (!data || !data.cells) return;

        grid.innerHTML = "";
        data.cells.forEach((cell) => {
          const card = document.createElement("div");
          card.style.background = "#111";
          card.style.border = "1px solid #333";
          card.style.borderRadius = "12px";
          card.style.padding = "12px";
          card.style.height = "150px";
          card.style.overflow = "hidden";

          const title = document.createElement("h4");
          title.innerText = `üìÑ ${cell.title}`;
          title.style.color = "#00e0ff";
          title.style.fontSize = "14px";
          title.style.marginBottom = "6px";

          const content = document.createElement("p");
          content.innerText = cell.content?.slice(0, 100) || "No content";
          content.style.fontSize = "12px";
          content.style.color = "#ccc";

          card.appendChild(title);
          card.appendChild(content);
          grid.appendChild(card);
        });
      });
    }

    function openStandaloneComplexModal() {
      document.getElementById("standalone-complex-modal").style.display = "flex";
    }

    function closeStandaloneComplexModal() {
      document.getElementById("standalone-complex-modal").style.display = "none";
    }


    function closeCellModal() {
      document.getElementById("cell-modal").style.display = "none";
    }

    function submitCell() {
      const title = document.getElementById("cell-title").value.trim();
      const content = document.getElementById("cell-content").value.trim();
      if (!title || !currentComplexId) {
        alert("Please provide a title and be inside a complex.");
        return;
      }
      const ref = db.collection("complexes").doc(currentComplexId);
      ref.update({
        cells: firebase.firestore.FieldValue.arrayUnion({ title, content })
      }).then(() => {
        document.getElementById("cell-title").value = "";
        document.getElementById("cell-content").value = "";
        closeAddCellModal();
      });
    }

    function toggleCommunityView() {
      showAll = !showAll;
      document.getElementById("toggle-view-btn").innerText = showAll ? "Show My Communities" : "Show All Communities";
      loadCommunities();
    }

    function renderCommunityCard(doc) {
      const data = doc.data();
      const hasJoined = data.members?.includes(userInfo.id);
      if (!showAll && !hasJoined) return;

      const card = document.createElement("div");
      card.className = "community-card";
      card.onclick = () => openDetailModal({ ...data, id: doc.id });

      const name = document.createElement("h3");
      name.innerText = `üìò ${data.name}`;

      const summary = document.createElement("p");
      summary.innerText = data.summary || "No summary provided.";

  // ‚úÖ Tags display
      const tagsContainer = document.createElement("div");
      tagsContainer.style.marginTop = "8px";
      if (Array.isArray(data.tags)) {
        data.tags.forEach(tag => {
          const tagEl = document.createElement("span");
          tagEl.className = "tag-badge";
          tagEl.innerText = `#${tag}`;

          tagsContainer.appendChild(tagEl);
        });
      }

      const joinBtn = document.createElement("button");
      joinBtn.className = "btn";
      joinBtn.innerText = hasJoined ? "‚úÖ Joined (Tap to Leave)" : "+ Join";
      joinBtn.onclick = (e) => {
        e.stopPropagation();
        const ref = db.collection("communities").doc(doc.id);
        if (hasJoined) {
          ref.update({ members: firebase.firestore.FieldValue.arrayRemove(userInfo.id) });
        } else {
          ref.update({ members: firebase.firestore.FieldValue.arrayUnion(userInfo.id) });
        }
      };

      card.appendChild(name);
      card.appendChild(summary);
      card.appendChild(tagsContainer);
      card.appendChild(joinBtn);

      document.getElementById("community-list").appendChild(card);
    }


    function renderMyCommunityCard(doc) {
      const data = doc.data();

      const card = document.createElement("div");
      card.className = "community-card";
      card.onclick = () => openDetailModal({ ...data, id: doc.id });

      const name = document.createElement("h3");
      name.innerText = `üìò ${data.name}`;

      const summary = document.createElement("p");
      summary.innerText = data.summary || "No summary provided.";

      // ‚úÖ Tags display with proper bubble styling
      const tagsContainer = document.createElement("div");
      tagsContainer.style.marginTop = "8px";
      if (Array.isArray(data.tags)) {
        data.tags.forEach(tag => {
          const tagEl = document.createElement("span");
          tagEl.className = "tag-badge";
          tagEl.innerText = `#${tag}`;
          tagsContainer.appendChild(tagEl);
        });
      }

      card.appendChild(name);
      card.appendChild(tagsContainer); // ‚úÖ Show tags under the name
      card.appendChild(summary);

      document.getElementById("my-community-list").appendChild(card);
    }


    function loadCommunities() {
      const container = document.getElementById("community-list");
      container.innerHTML = "";

      const sortBy = document.getElementById("community-sort")?.value || "newest";
      let query = db.collection("communities");

      if (sortBy === "newest") {
        query = query.orderBy("createdAt", "desc");
      } else if (sortBy === "members") {
        query = query.orderBy("memberCount", "desc");
      }

      query.onSnapshot((snapshot) => {
        snapshot.forEach((doc) => {
          const data = doc.data();
          const hasJoined = data.members?.includes(userInfo.id);
          if (!showAll && !hasJoined) return;

          const card = document.createElement("div");
          card.className = "community-card";
          card.onclick = () => openDetailModal({ ...data, id: doc.id });

          const name = document.createElement("h3");
          name.innerText = `üìò ${data.name}`;

          const summary = document.createElement("p");
          summary.innerText = data.summary || "No summary provided.";

          const count = document.createElement("p");
          count.innerText = `üë• ${data.members?.length || 0} members`;
          count.style.fontSize = "12px";
          count.style.color = "#888";

          const joinBtn = document.createElement("button");
          joinBtn.className = "btn";
          joinBtn.innerText = hasJoined ? "‚úÖ Joined (Tap to Leave)" : "+ Join";
          joinBtn.onclick = (e) => {
            e.stopPropagation();
            const ref = db.collection("communities").doc(doc.id);
            if (hasJoined) {
              ref.update({ 
                members: firebase.firestore.FieldValue.arrayRemove(userInfo.id),
                memberCount: firebase.firestore.FieldValue.increment(-1)
              });
            } else {
              ref.update({ 
                members: firebase.firestore.FieldValue.arrayUnion(userInfo.id),
                memberCount: firebase.firestore.FieldValue.increment(1)
              });
            }
          };

          card.appendChild(name);
          card.appendChild(summary);
          card.appendChild(count);
          card.appendChild(joinBtn);
          container.appendChild(card);
        });
      });
    }

    function loadUserProfile() {
      // Show basic Telegram info
      document.getElementById("profile-name").innerText = userInfo.first_name || "User";
      if (userInfo.photo_url) {
        document.getElementById("profile-photo").src = userInfo.photo_url;
      }

      const complexContainer = document.getElementById("user-complexes");
      const createdCommContainer = document.getElementById("user-created-communities");
      const joinedCommContainer = document.getElementById("user-joined-communities");
      const statsEl = document.getElementById("user-stats");

      complexContainer.innerHTML = "";
      createdCommContainer.innerHTML = "";
      joinedCommContainer.innerHTML = "";
      statsEl.innerHTML = "Loading...";

      let complexCount = 0;
      let createdCommCount = 0;
      let joinedCommCount = 0;

      // üß† Complexes Created
      db.collection("complexes").where("createdBy", "==", userInfo.id).onSnapshot(snapshot => {
        complexContainer.innerHTML = "";
        complexCount = snapshot.size;
        snapshot.forEach(doc => {
          const data = doc.data();
          const box = document.createElement("div");
          box.className = "complex-card";
          box.innerHTML = `
            <h2>üß† ${data.name}</h2>
            <p class="complex-summary">${data.summary || "No summary."}</p>
            <div class="complex-buttons">
              <button class="btn-complex" onclick='openCellModal(${JSON.stringify(data).replace(/"/g, "&quot;")}, "${doc.id}")'>üö™ Enter Complex</button>
              <button class="btn-outline">üîó Share</button>
            </div>
          `;
          complexContainer.appendChild(box);
        });
        updateStats();
      });

      // Track rendered community IDs to avoid duplicates
      const renderedCommunityIds = new Set();

      // üëë Communities Created
      db.collection("communities").where("createdBy", "==", userInfo.id).onSnapshot(snapshot => {
        createdCommContainer.innerHTML = "";
        createdCommCount = 0;
        snapshot.forEach(doc => {
          const data = doc.data();
          const box = document.createElement("div");
          box.className = "community-card";
          box.innerHTML = `<h3>üìò ${data.name}</h3><p>${data.summary || "No summary."}</p>`;
          box.onclick = () => openDetailModal({ ...data, id: doc.id });
          createdCommContainer.appendChild(box);
          renderedCommunityIds.add(doc.id); // Mark as rendered
          createdCommCount++;
        });
        updateStats();
      });

      // üß¨ Communities Joined
      db.collection("communities").where("members", "array-contains", userInfo.id).onSnapshot(snapshot => {
        joinedCommContainer.innerHTML = "";
        joinedCommCount = 0;
        snapshot.forEach(doc => {
          if (renderedCommunityIds.has(doc.id)) return; // Avoid duplicates
          const data = doc.data();
          const box = document.createElement("div");
          box.className = "community-card";
          box.innerHTML = `<h3>üìò ${data.name}</h3><p>${data.summary || "No summary."}</p>`;
          box.onclick = () => openDetailModal({ ...data, id: doc.id });
          joinedCommContainer.appendChild(box);
          joinedCommCount++;
        });
        updateStats();
      });

    function showProfileTab(tab) {
      document.getElementById("profile-communities").style.display = tab === "communities" ? "block" : "none";
      document.getElementById("profile-complexes").style.display = tab === "complexes" ? "block" : "none";

      // Optional: Highlight active tab button
      document.getElementById("tab-communities").style.opacity = tab === "communities" ? "1" : "0.5";
      document.getElementById("tab-complexes").style.opacity = tab === "complexes" ? "1" : "0.5";
    }


      
    function updateStats() {
      statsEl.innerHTML = `
        üì¶ ${complexCount} complexes<br>
        üëë ${createdCommCount} communities created<br>
        üß¨ ${joinedCommCount} communities joined
      `;
    }
  }

    function submitStandaloneComplex() {
      const name = document.getElementById("standalone-title").value.trim();
      const summary = document.getElementById("standalone-summary").value.trim();
      const cellTitle = document.getElementById("standalone-cell-title").value.trim();
      const cellContent = document.getElementById("standalone-cell-content").value.trim();

      if (!name || !cellTitle || !cellContent) {
        alert("Please fill all fields.");
        return;
      }

      const newComplex = {
        name,
        summary,
        createdAt: new Date(),
        createdBy: userInfo.id,
        cells: [{ title: cellTitle, content: cellContent }],
        communityId: null // Marked as standalone
      };

      db.collection("complexes").add(newComplex).then(() => {
        alert("‚úÖ Standalone Complex created!");
        closeStandaloneComplexModal();
        // ‚úÖ Clear all input fields
        document.getElementById("standalone-title").value = "";
        document.getElementById("standalone-summary").value = "";
        document.getElementById("standalone-cell-title").value = "";
        document.getElementById("standalone-cell-content").value = "";
        
        loadHomeComplexes(); // Refresh view
      });
    }


    function loadMyCommunities() {
      const createdContainer = document.getElementById("created-community-list");
      const joinedContainer = document.getElementById("joined-community-list");

      createdContainer.innerHTML = "";
      joinedContainer.innerHTML = "";

      db.collection("communities")
        .where("members", "array-contains", userInfo.id)
        .onSnapshot((snapshot) => {
          snapshot.forEach((doc) => {
            const data = doc.data();
            const card = document.createElement("div");
            card.className = "community-card";
            card.onclick = () => openDetailModal({ ...data, id: doc.id });

          const name = document.createElement("h3");
          name.innerText = `üìò ${data.name}`;

          const summary = document.createElement("p");
          summary.innerText = data.summary || "No summary provided.";

          card.appendChild(name);
          card.appendChild(summary);

          // Split between created and joined
          if (data.createdBy === userInfo.id) {
            createdContainer.appendChild(card);
          } else {
            joinedContainer.appendChild(card);
          }
        });
      });
  }


    loadCommunities();

    loadCommunities();        // ‚úÖ This line runs the function you defined
    loadHomeComplexes();      // ‚úÖ This line loads the complexes on the home tab

  </script>
</body>
</html>

